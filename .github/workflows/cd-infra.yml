# Infrastructure CD Pipeline (Terraform)
# Manages infrastructure changes through GitOps workflow
#
# ============================================================================
# NATS Infrastructure Notes
# ============================================================================
# NATS JetStreamÏùÄ Compute Engine VMÏóêÏÑú Container-Optimized OSÎ°ú Ïã§ÌñâÎê©ÎãàÎã§.
#
# Ï£ºÏöî Íµ¨ÏÑ±ÏöîÏÜå:
# - NATS VM: parkgolf-nats-{env} (e2-small/e2-medium)
# - NATS Ìè¨Ìä∏: 4222 (Client), 6222 (Cluster), 8222 (Monitoring)
# - VPC Connector: Cloud Run ‚Üî NATS ÌÜµÏã†
# - Firewall: allow-nats-{env} (4222, 6222, 8222 Ìè¨Ìä∏ ÌóàÏö©)
#
# NATS Ïª®ÌÖåÏù¥ÎÑà Ïù∏Ïàò (Ï§ëÏöî):
# - NATS 2.10ÏóêÏÑú ÏßÄÏõêÎêòÎäî Ïù∏ÏàòÎßå ÏÇ¨Ïö©Ìï¥Ïïº Ìï®
# - Ïò¨Î∞îÎ•∏ Ïù∏Ïàò: -js, -sd /data, -m 8222
# - ÏßÄÏõêÎêòÏßÄ ÏïäÎäî Ïù∏Ïàò: --jetstream_max_memory, --jetstream_max_file
#   (Ïù¥ ÏòµÏÖòÎì§ÏùÄ ÏÑ§Ï†ï ÌååÏùº(nats.conf)ÏóêÏÑúÎßå ÏßÄÏõêÎê®)
#
# Terraform Î™®Îìà ÏúÑÏπò: infra/modules/messaging/main.tf
# ÌôòÍ≤Ω ÏÑ§Ï†ï: infra/environments/{env}/main.tf
#
# NATS VM ÏàòÎèô Í¥ÄÎ¶¨ Î™ÖÎ†π:
#   # VM ÏãúÏûë: gcloud compute instances start parkgolf-nats-{env} --zone=asia-northeast3-a
#   # SSH Ï†ëÏÜç: gcloud compute ssh parkgolf-nats-{env} --tunnel-through-iap
#   # Ïª®ÌÖåÏù¥ÎÑà ÌôïÏù∏: docker ps -a | grep nats
#   # Ïª®ÌÖåÏù¥ÎÑà Î°úÍ∑∏: docker logs nats
# ============================================================================

name: CD Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      action:
        description: 'Terraform action'
        required: true
        type: choice
        options:
          - plan
          - apply
          - destroy
      target:
        description: 'Terraform target module (optional, e.g., module.messaging)'
        required: false
        type: string
        default: ''

permissions:
  contents: read
  pull-requests: write
  id-token: write

env:
  TF_VERSION: '1.6.0'
  TF_VAR_FILE: 'terraform.tfvars'
  GCP_PROJECT: 'parkgolf-uniyous'
  GCP_REGION: 'asia-northeast3'

jobs:
  # ============================================================================
  # Detect Environment
  # ============================================================================
  detect-environment:
    name: Detect Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      tf_dir: ${{ steps.dir.outputs.tf_dir }}
    steps:
      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine Terraform directory
        id: dir
        run: |
          ENV=${{ steps.env.outputs.environment }}
          echo "tf_dir=infra/environments/$ENV" >> $GITHUB_OUTPUT

  # ============================================================================
  # Terraform Validation
  # ============================================================================
  terraform-validate:
    name: Terraform Validate
    needs: detect-environment
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ needs.detect-environment.outputs.tf_dir }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: |
          terraform init -backend=false

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Comment PR - Validation
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `### Terraform Validation Results

            | Check | Status |
            |-------|--------|
            | Format | ${{ steps.fmt.outcome == 'success' && '‚úÖ Pass' || '‚ö†Ô∏è Needs formatting' }} |
            | Init | ${{ steps.init.outcome == 'success' && '‚úÖ Pass' || '‚ùå Failed' }} |
            | Validate | ${{ steps.validate.outcome == 'success' && '‚úÖ Pass' || '‚ùå Failed' }} |

            **Environment:** \`${{ needs.detect-environment.outputs.environment }}\`
            **Directory:** \`${{ needs.detect-environment.outputs.tf_dir }}\`
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # ============================================================================
  # Terraform Plan
  # ============================================================================
  terraform-plan:
    name: Terraform Plan
    needs: [detect-environment, terraform-validate]
    runs-on: ubuntu-latest
    environment: ${{ needs.detect-environment.outputs.environment }}-plan
    defaults:
      run:
        working-directory: ${{ needs.detect-environment.outputs.tf_dir }}
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Terraform Init
        run: terraform init

      - name: Create tfvars from secrets
        run: |
          ENV="${{ needs.detect-environment.outputs.environment }}"

          # Dev environment - uses external DB configured in cd-services.yml
          if [ "$ENV" == "dev" ]; then
            cat > terraform.tfvars << EOF
          jwt_secret         = "${{ secrets.JWT_SECRET }}"
          jwt_refresh_secret = "${{ secrets.JWT_REFRESH_SECRET }}"
          EOF
          fi

          # Prod environment - uses Cloud SQL with db_password
          if [ "$ENV" == "prod" ]; then
            cat > terraform.tfvars << EOF
          db_password        = "${{ secrets.DB_PASSWORD }}"
          jwt_secret         = "${{ secrets.JWT_SECRET }}"
          jwt_refresh_secret = "${{ secrets.JWT_REFRESH_SECRET }}"
          alert_email        = "${{ secrets.ALERT_EMAIL }}"
          ops_email          = "${{ secrets.OPS_EMAIL }}"
          slack_channel      = "${{ secrets.SLACK_CHANNEL }}"
          slack_token        = "${{ secrets.SLACK_TOKEN }}"
          EOF
          fi

          # Staging environment
          if [ "$ENV" == "staging" ]; then
            cat > terraform.tfvars << EOF
          db_password        = "${{ secrets.DB_PASSWORD }}"
          jwt_secret         = "${{ secrets.JWT_SECRET }}"
          jwt_refresh_secret = "${{ secrets.JWT_REFRESH_SECRET }}"
          alert_email        = "${{ secrets.ALERT_EMAIL }}"
          EOF
          fi

      - name: Terraform Plan
        id: plan
        run: |
          TARGET_OPTION=""
          if [ -n "${{ github.event.inputs.target }}" ]; then
            TARGET_OPTION="-target=${{ github.event.inputs.target }}"
            echo "üéØ Targeting: ${{ github.event.inputs.target }}"
          fi

          terraform plan \
            -var="environment=${{ needs.detect-environment.outputs.environment }}" \
            $TARGET_OPTION \
            -no-color \
            -detailed-exitcode \
            -out=tfplan 2>&1 | tee plan_output.txt
          echo "exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload Plan
        if: steps.plan.outputs.exitcode == '0' || steps.plan.outputs.exitcode == '2'
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ needs.detect-environment.outputs.environment }}
          path: |
            ${{ needs.detect-environment.outputs.tf_dir }}/tfplan
            ${{ needs.detect-environment.outputs.tf_dir }}/plan_output.txt
          retention-days: 7

      - name: Fail if plan failed
        if: steps.plan.outputs.exitcode == '1'
        run: |
          echo "‚ùå Terraform plan failed"
          exit 1

      - name: Comment PR - Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync('${{ needs.detect-environment.outputs.tf_dir }}/plan_output.txt', 'utf8');

            // Truncate if too long
            const maxLength = 60000;
            const truncated = planOutput.length > maxLength
              ? planOutput.substring(0, maxLength) + '\n\n... (truncated)'
              : planOutput;

            const exitCode = '${{ steps.plan.outputs.exitcode }}';
            let statusEmoji = '‚úÖ';
            let statusText = 'No changes detected';

            if (exitCode === '1') {
              statusEmoji = '‚ùå';
              statusText = 'Plan failed';
            } else if (exitCode === '2') {
              statusEmoji = '‚ö†Ô∏è';
              statusText = 'Changes detected';
            }

            const output = `### Terraform Plan ${statusEmoji}

            **Status:** ${statusText}
            **Environment:** \`${{ needs.detect-environment.outputs.environment }}\`

            <details><summary>Show Plan Output</summary>

            \`\`\`terraform
            ${truncated}
            \`\`\`

            </details>

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

  # ============================================================================
  # Terraform Apply
  # ============================================================================
  terraform-apply:
    name: Terraform Apply
    needs: [detect-environment, terraform-plan]
    if: |
      needs.terraform-plan.outputs.plan_exitcode != '1' &&
      (
        (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
        (github.event_name == 'push' && github.ref == 'refs/heads/develop') ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'apply')
      )
    runs-on: ubuntu-latest
    environment: ${{ needs.detect-environment.outputs.environment }}
    defaults:
      run:
        working-directory: ${{ needs.detect-environment.outputs.tf_dir }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ needs.detect-environment.outputs.environment }}
          path: ${{ needs.detect-environment.outputs.tf_dir }}

      - name: Verify Plan File
        run: |
          if [ ! -f "tfplan" ]; then
            echo "‚ùå tfplan file not found!"
            ls -la
            exit 1
          fi
          echo "‚úÖ tfplan file found"

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

      - name: Notify Success
        if: success()
        run: |
          echo "‚úÖ Infrastructure applied successfully to ${{ needs.detect-environment.outputs.environment }}"

      - name: Notify Failure
        if: failure()
        run: |
          echo "‚ùå Infrastructure apply failed for ${{ needs.detect-environment.outputs.environment }}"

  # ============================================================================
  # Terraform Destroy (Manual Only)
  # ============================================================================
  terraform-destroy:
    name: Terraform Destroy
    needs: detect-environment
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action == 'destroy'
    runs-on: ubuntu-latest
    environment: ${{ needs.detect-environment.outputs.environment }}-destroy
    defaults:
      run:
        working-directory: ${{ needs.detect-environment.outputs.tf_dir }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Safety Check
        if: needs.detect-environment.outputs.environment == 'prod'
        run: |
          echo "‚ö†Ô∏è DANGER: Destroying production infrastructure!"
          echo "This action requires explicit approval."

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Init
        run: terraform init

      - name: Create tfvars from secrets
        run: |
          ENV="${{ needs.detect-environment.outputs.environment }}"

          # Dev environment - uses external DB configured in cd-services.yml
          if [ "$ENV" == "dev" ]; then
            cat > terraform.tfvars << EOF
          jwt_secret         = "${{ secrets.JWT_SECRET }}"
          jwt_refresh_secret = "${{ secrets.JWT_REFRESH_SECRET }}"
          EOF
          fi

          # Prod environment - uses Cloud SQL with db_password
          if [ "$ENV" == "prod" ]; then
            cat > terraform.tfvars << EOF
          db_password        = "${{ secrets.DB_PASSWORD }}"
          jwt_secret         = "${{ secrets.JWT_SECRET }}"
          jwt_refresh_secret = "${{ secrets.JWT_REFRESH_SECRET }}"
          alert_email        = "${{ secrets.ALERT_EMAIL }}"
          ops_email          = "${{ secrets.OPS_EMAIL }}"
          slack_channel      = "${{ secrets.SLACK_CHANNEL }}"
          slack_token        = "${{ secrets.SLACK_TOKEN }}"
          EOF
          fi

          # Staging environment
          if [ "$ENV" == "staging" ]; then
            cat > terraform.tfvars << EOF
          db_password        = "${{ secrets.DB_PASSWORD }}"
          jwt_secret         = "${{ secrets.JWT_SECRET }}"
          jwt_refresh_secret = "${{ secrets.JWT_REFRESH_SECRET }}"
          alert_email        = "${{ secrets.ALERT_EMAIL }}"
          EOF
          fi

      - name: Terraform Destroy
        run: |
          ENV="${{ needs.detect-environment.outputs.environment }}"

          # If targeting specific module, destroy only that
          if [ -n "${{ github.event.inputs.target }}" ]; then
            echo "üéØ Targeting: ${{ github.event.inputs.target }}"
            terraform destroy \
              -var="environment=$ENV" \
              -target=${{ github.event.inputs.target }} \
              -auto-approve
          else
            # Full destroy: services must be destroyed before networking
            # Step 1: Destroy Cloud Run services first (releases VPC resources)
            echo "üì¶ Step 1: Destroying Cloud Run services..."
            terraform destroy \
              -var="environment=$ENV" \
              -target=module.services \
              -auto-approve || true

            # Step 2: Destroy remaining infrastructure
            echo "üèóÔ∏è Step 2: Destroying remaining infrastructure..."
            terraform destroy \
              -var="environment=$ENV" \
              -auto-approve
          fi
