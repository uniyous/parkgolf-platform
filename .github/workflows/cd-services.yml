# Backend Services CD Pipeline
# Builds, pushes, and deploys backend services to Cloud Run
#
# ============================================================================
# Infrastructure Architecture (External IP 방식)
# ============================================================================
# Cloud Run 서비스가 VM의 External IP를 통해 직접 접속합니다.
# (VPC Connector 대신 External IP 방식 사용)
#
# NATS 연결 설정:
# - 환경변수: NATS_URL (GitHub Secrets에서 관리)
# - NATS VM External IP를 통해 직접 연결
# - Firewall: 0.0.0.0/0 → :4222 허용
#
# Database 연결:
# - PostgreSQL VM External IP를 통해 직접 연결
# - Firewall: 0.0.0.0/0 → :5432 허용
# - 보안: DB 비밀번호 인증
#
# 서비스별 NATS 사용:
# - auth-service: auth.*, users.* 패턴 처리
# - course-service: course.*, hole.*, company.* 패턴 처리
# - booking-service: booking.* 패턴 처리
# - notify-service: notification.> 구독
# - admin-api: 모든 서비스에 NATS Request 전송
# - user-api: auth.*, booking.*, course.* Request 전송
#
# 문제 해결:
# 1. NATS VM 상태 확인: gcloud compute instances list --filter="name~nats"
# 2. Firewall 확인: gcloud compute firewall-rules list --filter="name~nats"
# 3. Cloud Run 로그 확인: gcloud run logs read --service={service}-{env}
# ============================================================================

name: CD Services

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - prod
      services:
        description: 'Services to deploy (comma-separated or "all")'
        required: true
        default: 'all'

permissions:
  contents: read
  id-token: write

concurrency:
  group: cd-services-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  REGISTRY: asia-northeast3-docker.pkg.dev
  PROJECT_ID: parkgolf-uniyous
  REPOSITORY: parkgolf
  REGION: asia-northeast3

jobs:
  # ============================================================================
  # Setup
  # ============================================================================
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      services: ${{ steps.services.outputs.list }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

      - name: Determine services to deploy
        id: services
        run: |
          ALL_SERVICES='["auth-service","course-service","booking-service","notify-service","admin-api","user-api"]'

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            INPUT_SERVICES="${{ github.event.inputs.services }}"
            # Remove quotes and trim whitespace
            INPUT_SERVICES=$(echo "$INPUT_SERVICES" | tr -d '"' | tr -d "'" | xargs)

            if [ "$INPUT_SERVICES" == "all" ]; then
              echo "list=$ALL_SERVICES" >> $GITHUB_OUTPUT
            else
              # Split by comma, trim whitespace, and format as JSON array
              SERVICES=$(echo "$INPUT_SERVICES" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R -s -c 'split("\n") | map(select(length > 0))')
              echo "list=$SERVICES" >> $GITHUB_OUTPUT
            fi
          else
            # For push events, detect changed services
            CHANGED_SERVICES=$(git diff --name-only HEAD~1 HEAD -- services/ | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
            if [ "$CHANGED_SERVICES" == "[]" ]; then
              echo "list=$ALL_SERVICES" >> $GITHUB_OUTPUT
            else
              echo "list=$CHANGED_SERVICES" >> $GITHUB_OUTPUT
            fi
          fi

  # ============================================================================
  # Build and Push
  # ============================================================================
  build:
    name: Build ${{ matrix.service }}
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.setup.outputs.services) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      - name: Set image tags
        id: tags
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          IMAGE_BASE="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ matrix.service }}"
          echo "sha_tag=${IMAGE_BASE}:${ENV}-${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "latest_tag=${IMAGE_BASE}:${ENV}-latest" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        run: |
          docker build \
            -t ${{ steps.tags.outputs.sha_tag }} \
            -t ${{ steps.tags.outputs.latest_tag }} \
            -f services/${{ matrix.service }}/Dockerfile \
            --build-arg NODE_ENV=${{ needs.setup.outputs.environment == 'prod' && 'production' || 'development' }} \
            services/${{ matrix.service }}

          docker push ${{ steps.tags.outputs.sha_tag }}
          docker push ${{ steps.tags.outputs.latest_tag }}

  # ============================================================================
  # Deploy to Cloud Run
  # ============================================================================
  deploy:
    name: Deploy ${{ matrix.service }}
    needs: [setup, build]
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.setup.outputs.services) }}
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Set deployment variables
        id: vars
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          SERVICE_NAME="${{ matrix.service }}-${ENV}"
          IMAGE="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ matrix.service }}:${ENV}-${{ github.sha }}"

          echo "service_name=${SERVICE_NAME}" >> $GITHUB_OUTPUT
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT

          # Service-specific resource settings
          SERVICE="${{ matrix.service }}"
          ENV="${{ needs.setup.outputs.environment }}"

          if [ "$ENV" == "prod" ]; then
            # Production: higher resources
            if [ "$SERVICE" == "auth-service" ]; then
              # auth-service: Always running, no CPU throttling (bcrypt CPU-intensive)
              echo "min_instances=1" >> $GITHUB_OUTPUT
              echo "max_instances=10" >> $GITHUB_OUTPUT
              echo "memory=1Gi" >> $GITHUB_OUTPUT
              echo "cpu=2" >> $GITHUB_OUTPUT
              echo "cpu_throttling=false" >> $GITHUB_OUTPUT
            else
              # Other services: scale-to-zero, minimal resources
              echo "min_instances=0" >> $GITHUB_OUTPUT
              echo "max_instances=10" >> $GITHUB_OUTPUT
              echo "memory=512Mi" >> $GITHUB_OUTPUT
              echo "cpu=1" >> $GITHUB_OUTPUT
              echo "cpu_throttling=true" >> $GITHUB_OUTPUT
            fi
          else
            # Development: minimal resources for cost optimization
            if [ "$SERVICE" == "auth-service" ]; then
              # auth-service: Always running, no CPU throttling (bcrypt CPU-intensive)
              echo "min_instances=1" >> $GITHUB_OUTPUT
              echo "max_instances=1" >> $GITHUB_OUTPUT
              echo "memory=256Mi" >> $GITHUB_OUTPUT
              echo "cpu=1" >> $GITHUB_OUTPUT
              echo "cpu_throttling=false" >> $GITHUB_OUTPUT
            else
              # Other services: scale-to-zero, minimal resources (same as notify-service)
              echo "min_instances=0" >> $GITHUB_OUTPUT
              echo "max_instances=1" >> $GITHUB_OUTPUT
              echo "memory=128Mi" >> $GITHUB_OUTPUT
              echo "cpu=0.5" >> $GITHUB_OUTPUT
              echo "cpu_throttling=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Deploy to Cloud Run
        env:
          # Service-specific DATABASE_URL secrets (for services with Prisma)
          DATABASE_URL_AUTH_SERVICE: ${{ secrets.DATABASE_URL_AUTH_SERVICE }}
          DATABASE_URL_COURSE_SERVICE: ${{ secrets.DATABASE_URL_COURSE_SERVICE }}
          DATABASE_URL_BOOKING_SERVICE: ${{ secrets.DATABASE_URL_BOOKING_SERVICE }}
          DATABASE_URL_NOTIFY_SERVICE: ${{ secrets.DATABASE_URL_NOTIFY_SERVICE }}
        run: |
          SERVICE="${{ matrix.service }}"
          SERVICE_UPPER=$(echo "$SERVICE" | tr '[:lower:]-' '[:upper:]_')

          # Build env vars string (required)
          ENV_VARS="NODE_ENV=${{ needs.setup.outputs.environment == 'prod' && 'production' || 'development' }}"
          ENV_VARS="${ENV_VARS},JWT_SECRET=${{ secrets.JWT_SECRET }}"
          ENV_VARS="${ENV_VARS},JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}"
          ENV_VARS="${ENV_VARS},NATS_URL=${{ secrets.NATS_URL }}"

          # Add DATABASE_URL only for services with Prisma (not admin-api, user-api)
          if [ "$SERVICE" != "admin-api" ] && [ "$SERVICE" != "user-api" ]; then
            DB_URL_VAR="DATABASE_URL_${SERVICE_UPPER}"
            DB_URL="${!DB_URL_VAR}"
            # Debug: Log DATABASE_URL (masked password)
            echo "Service: $SERVICE"
            echo "DB_URL_VAR: $DB_URL_VAR"
            echo "DATABASE_URL: $(echo "$DB_URL" | sed 's/:[^@]*@/:****@/')"
            ENV_VARS="${ENV_VARS},DATABASE_URL=${DB_URL}"
          fi

          # Set CPU throttling flag
          if [ "${{ steps.vars.outputs.cpu_throttling }}" == "false" ]; then
            CPU_THROTTLING_FLAG="--no-cpu-throttling"
          else
            CPU_THROTTLING_FLAG="--cpu-throttling"
          fi

          # Deploy to Cloud Run (External IP 방식 - VPC Connector 없음)
          gcloud run deploy ${{ steps.vars.outputs.service_name }} \
            --image ${{ steps.vars.outputs.image }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --min-instances ${{ steps.vars.outputs.min_instances }} \
            --max-instances ${{ steps.vars.outputs.max_instances }} \
            --memory ${{ steps.vars.outputs.memory }} \
            --cpu ${{ steps.vars.outputs.cpu }} \
            --timeout 300 \
            ${CPU_THROTTLING_FLAG} \
            --set-env-vars "${ENV_VARS}"

      - name: Get Service URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ steps.vars.outputs.service_name }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "### ${{ matrix.service }} deployed" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- URL: $SERVICE_URL" >> $GITHUB_STEP_SUMMARY
