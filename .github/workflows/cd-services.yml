# Backend Services CD Pipeline
# Builds, pushes, and deploys backend services to Cloud Run

name: CD Services

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      services:
        description: 'Services to deploy (comma-separated or "all")'
        required: true
        default: 'all'

permissions:
  contents: read
  id-token: write

concurrency:
  group: cd-services-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  REGISTRY: asia-northeast3-docker.pkg.dev
  PROJECT_ID: parkgolf-uniyous
  REPOSITORY: parkgolf
  REGION: asia-northeast3

jobs:
  # ============================================================================
  # Setup
  # ============================================================================
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      services: ${{ steps.services.outputs.list }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

      - name: Determine services to deploy
        id: services
        run: |
          ALL_SERVICES='["auth-service","course-service","booking-service","notify-service","admin-api","user-api"]'

          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            INPUT_SERVICES="${{ github.event.inputs.services }}"
            # Remove quotes and trim whitespace
            INPUT_SERVICES=$(echo "$INPUT_SERVICES" | tr -d '"' | tr -d "'" | xargs)

            if [ "$INPUT_SERVICES" == "all" ]; then
              echo "list=$ALL_SERVICES" >> $GITHUB_OUTPUT
            else
              # Split by comma, trim whitespace, and format as JSON array
              SERVICES=$(echo "$INPUT_SERVICES" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R -s -c 'split("\n") | map(select(length > 0))')
              echo "list=$SERVICES" >> $GITHUB_OUTPUT
            fi
          else
            # For push events, detect changed services
            CHANGED_SERVICES=$(git diff --name-only HEAD~1 HEAD -- services/ | cut -d'/' -f2 | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')
            if [ "$CHANGED_SERVICES" == "[]" ]; then
              echo "list=$ALL_SERVICES" >> $GITHUB_OUTPUT
            else
              echo "list=$CHANGED_SERVICES" >> $GITHUB_OUTPUT
            fi
          fi

  # ============================================================================
  # Build and Push
  # ============================================================================
  build:
    name: Build ${{ matrix.service }}
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.setup.outputs.services) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      - name: Set image tags
        id: tags
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          IMAGE_BASE="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ matrix.service }}"
          echo "sha_tag=${IMAGE_BASE}:${ENV}-${{ github.sha }}" >> $GITHUB_OUTPUT
          echo "latest_tag=${IMAGE_BASE}:${ENV}-latest" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        run: |
          docker build \
            -t ${{ steps.tags.outputs.sha_tag }} \
            -t ${{ steps.tags.outputs.latest_tag }} \
            -f services/${{ matrix.service }}/Dockerfile \
            --build-arg NODE_ENV=${{ needs.setup.outputs.environment == 'prod' && 'production' || 'development' }} \
            services/${{ matrix.service }}

          docker push ${{ steps.tags.outputs.sha_tag }}
          docker push ${{ steps.tags.outputs.latest_tag }}

  # ============================================================================
  # Deploy to Cloud Run
  # ============================================================================
  deploy:
    name: Deploy ${{ matrix.service }}
    needs: [setup, build]
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJson(needs.setup.outputs.services) }}
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Set deployment variables
        id: vars
        run: |
          ENV="${{ needs.setup.outputs.environment }}"
          SERVICE_NAME="${{ matrix.service }}-${ENV}"
          IMAGE="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ matrix.service }}:${ENV}-${{ github.sha }}"

          echo "service_name=${SERVICE_NAME}" >> $GITHUB_OUTPUT
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT

          # Environment-specific settings
          if [ "$ENV" == "prod" ]; then
            echo "min_instances=1" >> $GITHUB_OUTPUT
            echo "max_instances=10" >> $GITHUB_OUTPUT
            echo "memory=1Gi" >> $GITHUB_OUTPUT
            echo "cpu=2" >> $GITHUB_OUTPUT
          else
            echo "min_instances=0" >> $GITHUB_OUTPUT
            echo "max_instances=2" >> $GITHUB_OUTPUT
            echo "memory=512Mi" >> $GITHUB_OUTPUT
            echo "cpu=1" >> $GITHUB_OUTPUT
          fi

      - name: Set service-specific environment variables
        id: service_env
        run: |
          SERVICE="${{ matrix.service }}"
          ENV="${{ needs.setup.outputs.environment }}"

          # Convert service name to uppercase for secret lookup (e.g., auth-service -> AUTH_SERVICE)
          SERVICE_UPPER=$(echo "$SERVICE" | tr '[:lower:]-' '[:upper:]_')

          # Set service-specific DATABASE_URL secret name
          echo "db_secret_name=DATABASE_URL_${SERVICE_UPPER}" >> $GITHUB_OUTPUT

          # Set Cloud Run internal URLs for BFF services
          if [ "$ENV" == "prod" ]; then
            AUTH_URL="https://auth-service-prod-xxxxxxxxxx-an.a.run.app"
            COURSE_URL="https://course-service-prod-xxxxxxxxxx-an.a.run.app"
            BOOKING_URL="https://booking-service-prod-xxxxxxxxxx-an.a.run.app"
            NOTIFY_URL="https://notify-service-prod-xxxxxxxxxx-an.a.run.app"
          else
            AUTH_URL="https://auth-service-dev-xxxxxxxxxx-an.a.run.app"
            COURSE_URL="https://course-service-dev-xxxxxxxxxx-an.a.run.app"
            BOOKING_URL="https://booking-service-dev-xxxxxxxxxx-an.a.run.app"
            NOTIFY_URL="https://notify-service-dev-xxxxxxxxxx-an.a.run.app"
          fi

          echo "auth_url=${AUTH_URL}" >> $GITHUB_OUTPUT
          echo "course_url=${COURSE_URL}" >> $GITHUB_OUTPUT
          echo "booking_url=${BOOKING_URL}" >> $GITHUB_OUTPUT
          echo "notify_url=${NOTIFY_URL}" >> $GITHUB_OUTPUT

      - name: Deploy to Cloud Run
        env:
          # Service-specific DATABASE_URL secrets
          DATABASE_URL_AUTH_SERVICE: ${{ secrets.DATABASE_URL_AUTH_SERVICE }}
          DATABASE_URL_COURSE_SERVICE: ${{ secrets.DATABASE_URL_COURSE_SERVICE }}
          DATABASE_URL_BOOKING_SERVICE: ${{ secrets.DATABASE_URL_BOOKING_SERVICE }}
          DATABASE_URL_NOTIFY_SERVICE: ${{ secrets.DATABASE_URL_NOTIFY_SERVICE }}
          DATABASE_URL_ADMIN_API: ${{ secrets.DATABASE_URL_ADMIN_API }}
          DATABASE_URL_USER_API: ${{ secrets.DATABASE_URL_USER_API }}
        run: |
          SERVICE="${{ matrix.service }}"
          SERVICE_UPPER=$(echo "$SERVICE" | tr '[:lower:]-' '[:upper:]_')

          # Get service-specific DATABASE_URL
          DB_URL_VAR="DATABASE_URL_${SERVICE_UPPER}"
          DB_URL="${!DB_URL_VAR}"

          # Build env vars string
          ENV_VARS="NODE_ENV=${{ needs.setup.outputs.environment == 'prod' && 'production' || 'development' }}"
          ENV_VARS="${ENV_VARS},JWT_SECRET=${{ secrets.JWT_SECRET }}"
          ENV_VARS="${ENV_VARS},JWT_EXPIRES_IN=${{ secrets.JWT_EXPIRES_IN || '7d' }}"
          ENV_VARS="${ENV_VARS},JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}"
          ENV_VARS="${ENV_VARS},JWT_REFRESH_EXPIRES_IN=${{ secrets.JWT_REFRESH_EXPIRES_IN || '30d' }}"

          # Add DATABASE_URL if available
          if [ -n "$DB_URL" ]; then
            ENV_VARS="${ENV_VARS},DATABASE_URL=${DB_URL}"
          fi

          # Add NATS_URL (required)
          ENV_VARS="${ENV_VARS},NATS_URL=${{ secrets.NATS_URL }}"

          # Add REDIS_URL if available
          if [ -n "${{ secrets.REDIS_URL }}" ]; then
            ENV_VARS="${ENV_VARS},REDIS_URL=${{ secrets.REDIS_URL }}"
          fi

          # Add service URLs for BFF services (admin-api, user-api)
          if [ "$SERVICE" == "admin-api" ] || [ "$SERVICE" == "user-api" ]; then
            ENV_VARS="${ENV_VARS},AUTH_SERVICE_URL=${{ steps.service_env.outputs.auth_url }}"
            ENV_VARS="${ENV_VARS},COURSE_SERVICE_URL=${{ steps.service_env.outputs.course_url }}"
            ENV_VARS="${ENV_VARS},BOOKING_SERVICE_URL=${{ steps.service_env.outputs.booking_url }}"
            ENV_VARS="${ENV_VARS},NOTIFY_SERVICE_URL=${{ steps.service_env.outputs.notify_url }}"
          fi

          gcloud run deploy ${{ steps.vars.outputs.service_name }} \
            --image ${{ steps.vars.outputs.image }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --min-instances ${{ steps.vars.outputs.min_instances }} \
            --max-instances ${{ steps.vars.outputs.max_instances }} \
            --memory ${{ steps.vars.outputs.memory }} \
            --cpu ${{ steps.vars.outputs.cpu }} \
            --timeout 300 \
            --set-env-vars "${ENV_VARS}"

      - name: Get Service URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ steps.vars.outputs.service_name }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "### ${{ matrix.service }} deployed" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ${{ needs.setup.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- URL: $SERVICE_URL" >> $GITHUB_STEP_SUMMARY
