name: Deploy Backend Services to GCP

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'services/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to deploy (comma-separated or "all")'
        required: false
        default: 'all'

env:
  GCP_PROJECT_ID: uniyous-319808
  REGION: asia-northeast3
  SERVICE_ACCOUNT_EMAIL: parkgolf-services@uniyous-319808.iam.gserviceaccount.com
  NATS_URL: nats://34.64.85.225:4222
  NATS_USER: nats
  NATS_PASSWORD: nats123
  DATABASE_HOST: 34.47.122.22
  DATABASE_PORT: 5432
  DATABASE_USER: postgres
  DATABASE_PASSWORD: postgres123

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.determine-services.outputs.services }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine services to deploy
        id: determine-services
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.services }}" == "all" ]; then
              echo "services=[\"auth-service\",\"course-service\",\"booking-service\",\"notify-service\",\"admin-api\",\"user-api\"]" >> $GITHUB_OUTPUT
            else
              # Convert comma-separated list to JSON array
              services=$(echo "${{ github.event.inputs.services }}" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
              echo "services=$services" >> $GITHUB_OUTPUT
            fi
          else
            # For push events, deploy all services
            echo "services=[\"auth-service\",\"course-service\",\"booking-service\",\"notify-service\",\"admin-api\",\"user-api\"]" >> $GITHUB_OUTPUT
          fi

  deploy-service:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.setup.outputs.services) }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Configure Docker for GCP
        run: |
          gcloud auth configure-docker asia-northeast3-docker.pkg.dev

      - name: Set environment variables for service
        id: env-vars
        run: |
          case "${{ matrix.service }}" in
            auth-service)
              echo "PORT=3011" >> $GITHUB_OUTPUT
              echo "DATABASE_NAME=auth_db" >> $GITHUB_OUTPUT
              echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> $GITHUB_OUTPUT
              echo "REDIS_URL=redis://${{ secrets.REDIS_HOST }}:6379" >> $GITHUB_OUTPUT
              ;;
            course-service)
              echo "PORT=3012" >> $GITHUB_OUTPUT
              echo "DATABASE_NAME=course_db" >> $GITHUB_OUTPUT
              ;;
            booking-service)
              echo "PORT=3013" >> $GITHUB_OUTPUT
              echo "DATABASE_NAME=booking_db" >> $GITHUB_OUTPUT
              ;;
            notify-service)
              echo "PORT=3014" >> $GITHUB_OUTPUT
              echo "DATABASE_NAME=notify_db" >> $GITHUB_OUTPUT
              echo "SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}" >> $GITHUB_OUTPUT
              echo "TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}" >> $GITHUB_OUTPUT
              echo "TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}" >> $GITHUB_OUTPUT
              ;;
            admin-api)
              echo "PORT=3091" >> $GITHUB_OUTPUT
              echo "REDIS_URL=redis://${{ secrets.REDIS_HOST }}:6379" >> $GITHUB_OUTPUT
              ;;
            user-api)
              echo "PORT=3092" >> $GITHUB_OUTPUT
              echo "REDIS_URL=redis://${{ secrets.REDIS_HOST }}:6379" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Build Docker image
        run: |
          docker build \
            -t asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:${{ github.sha }} \
            -t asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:latest \
            -f services/${{ matrix.service }}/Dockerfile \
            --build-arg NODE_ENV=production \
            services/${{ matrix.service }}

      - name: Push Docker image
        run: |
          docker push asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:${{ github.sha }}
          docker push asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ matrix.service }} \
            --image asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --port ${{ steps.env-vars.outputs.PORT }} \
            --service-account ${{ env.SERVICE_ACCOUNT_EMAIL }} \
            --set-env-vars NODE_ENV=production \
            --set-env-vars PORT=${{ steps.env-vars.outputs.PORT }} \
            --set-env-vars NATS_URL=${{ env.NATS_URL }} \
            --set-env-vars NATS_USER=${{ env.NATS_USER }} \
            --set-env-vars NATS_PASSWORD=${{ env.NATS_PASSWORD }} \
            --set-env-vars DATABASE_HOST=${{ env.DATABASE_HOST }} \
            --set-env-vars DATABASE_PORT=${{ env.DATABASE_PORT }} \
            --set-env-vars DATABASE_USER=${{ env.DATABASE_USER }} \
            --set-env-vars DATABASE_PASSWORD=${{ env.DATABASE_PASSWORD }} \
            --set-env-vars DATABASE_NAME=${{ steps.env-vars.outputs.DATABASE_NAME }} \
            --set-env-vars JWT_SECRET=${{ steps.env-vars.outputs.JWT_SECRET }} \
            --set-env-vars REDIS_URL=${{ steps.env-vars.outputs.REDIS_URL }} \
            --set-env-vars SENDGRID_API_KEY=${{ steps.env-vars.outputs.SENDGRID_API_KEY }} \
            --set-env-vars TWILIO_ACCOUNT_SID=${{ steps.env-vars.outputs.TWILIO_ACCOUNT_SID }} \
            --set-env-vars TWILIO_AUTH_TOKEN=${{ steps.env-vars.outputs.TWILIO_AUTH_TOKEN }} \
            --min-instances 1 \
            --max-instances 10 \
            --memory 512Mi \
            --cpu 1

      - name: Get Service URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ matrix.service }} --region=${{ env.REGION }} --format='value(status.url)')
          echo "Service deployed to: $SERVICE_URL"