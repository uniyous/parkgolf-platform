name: Deploy Backend Services to GCP

on:
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to deploy (comma-separated or "all")'
        required: false
        default: 'all'
      environment:
        description: 'Target environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production

# Prevent concurrent deployments to same environment
concurrency:
  group: deploy-backend-${{ github.event.inputs.environment || 'development' }}
  cancel-in-progress: true

env:
  GCP_PROJECT_ID: uniyous-319808
  REGION: asia-northeast3
  SERVICE_ACCOUNT_EMAIL: parkgolf-services@uniyous-319808.iam.gserviceaccount.com

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      services: ${{ steps.determine-services.outputs.services }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 1
          clean: true
        timeout-minutes: 10

      - name: Determine services to deploy
        id: determine-services
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.services }}" == "all" ]; then
              # Deploy all services including NATS with HTTP health check
              echo "services=[\"auth-service\",\"course-service\",\"booking-service\",\"admin-api\",\"user-api\"]" >> $GITHUB_OUTPUT
            else
              # Convert comma-separated list to JSON array
              services=$(echo "${{ github.event.inputs.services }}" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
              echo "services=$services" >> $GITHUB_OUTPUT
            fi
          else
            # For push events, deploy all services
            echo "services=[\"auth-service\",\"course-service\",\"booking-service\",\"notify-service\",\"admin-api\",\"user-api\"]" >> $GITHUB_OUTPUT
          fi

  deploy-service:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      matrix:
        service: ${{ fromJson(needs.setup.outputs.services) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 1
          clean: true
        timeout-minutes: 10

      - name: Set deployment environment
        id: deployment-env
        run: |
          SELECTED_ENV="${{ github.event.inputs.environment }}"

          # Parse environment configuration from JSON with error handling
          if [[ "$SELECTED_ENV" == "production" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_OUTPUT
            echo "SERVICE_SUFFIX=-prod" >> $GITHUB_OUTPUT
            echo "NODE_ENV=production" >> $GITHUB_OUTPUT

            # Parse production config JSON
            if [ -n "${{ secrets.PROD_ENV_CONFIG }}" ]; then
              CONFIG_JSON='${{ secrets.PROD_ENV_CONFIG }}'
            else
              CONFIG_JSON='${{ secrets.DEV_ENV_CONFIG }}'
            fi
          else
            echo "ENVIRONMENT=development" >> $GITHUB_OUTPUT
            echo "SERVICE_SUFFIX=-dev" >> $GITHUB_OUTPUT
            echo "NODE_ENV=development" >> $GITHUB_OUTPUT

            # Parse development config JSON
            CONFIG_JSON='${{ secrets.DEV_ENV_CONFIG }}'
          fi

          # Validate and extract environment variables from JSON
          if [ -n "$CONFIG_JSON" ]; then
            echo "ðŸ” Validating JSON configuration..."

            # Use printf to properly handle the JSON string
            printf '%s\n' "$CONFIG_JSON" > /tmp/config.json

            if jq empty /tmp/config.json 2>/dev/null; then
              echo "âœ… JSON is valid, extracting variables..."

              # Extract variables with fallback to empty string for optional fields
              echo "AUTH_DATABASE_URL=$(jq -r '.database.auth_url // ""' /tmp/config.json)" >> $GITHUB_OUTPUT
              echo "COURSE_DATABASE_URL=$(jq -r '.database.course_url // ""' /tmp/config.json)" >> $GITHUB_OUTPUT
              echo "BOOKING_DATABASE_URL=$(jq -r '.database.booking_url // ""' /tmp/config.json)" >> $GITHUB_OUTPUT
              echo "SERVER_PORT=$(jq -r '.server.port // "8080"' /tmp/config.json)" >> $GITHUB_OUTPUT
              echo "JWT_SECRET=$(jq -r '.jwt.secret // ""' /tmp/config.json)" >> $GITHUB_OUTPUT
              echo "JWT_EXPIRES_IN=$(jq -r '.jwt.expires_in // "7d"' /tmp/config.json)" >> $GITHUB_OUTPUT
              echo "JWT_REFRESH_SECRET=$(jq -r '.jwt.refresh_secret // ""' /tmp/config.json)" >> $GITHUB_OUTPUT
              echo "JWT_REFRESH_EXPIRES_IN=$(jq -r '.jwt.refresh_expires_in // "30d"' /tmp/config.json)" >> $GITHUB_OUTPUT
              echo "REDIS_URL=$(jq -r '.redis.url // ""' /tmp/config.json)" >> $GITHUB_OUTPUT
              echo "NATS_URL=$(jq -r '.nats.url // ""' /tmp/config.json)" >> $GITHUB_OUTPUT

              # Clean up temp file
              rm -f /tmp/config.json
            else
              echo "âŒ Invalid JSON format in environment configuration"
              echo "jq error details:"
              jq empty /tmp/config.json 2>&1 || true
              echo "Raw content (first 500 chars):"
              head -c 500 /tmp/config.json
              rm -f /tmp/config.json
              exit 1
            fi
          else
            echo "âŒ No environment configuration found"
            exit 1
          fi

          echo "ðŸ”§ Selected environment: $SELECTED_ENV"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCP
        run: |
          gcloud auth configure-docker asia-northeast3-docker.pkg.dev --quiet

      - name: Set environment variables for service
        id: env-vars
        run: |
          case "${{ matrix.service }}" in
            auth-service)
              echo "DATABASE_URL=${{ steps.deployment-env.outputs.AUTH_DATABASE_URL }}" >> $GITHUB_OUTPUT
              ;;
            course-service)
              echo "DATABASE_URL=${{ steps.deployment-env.outputs.COURSE_DATABASE_URL }}" >> $GITHUB_OUTPUT
              ;;
            booking-service)
              echo "DATABASE_URL=${{ steps.deployment-env.outputs.BOOKING_DATABASE_URL }}" >> $GITHUB_OUTPUT
              ;;
            admin-api)
              echo "DATABASE_URL=" >> $GITHUB_OUTPUT
              ;;
            user-api)
              echo "DATABASE_URL=" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Build Docker image
        run: |
          docker build \
            -t asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:${{ steps.deployment-env.outputs.ENVIRONMENT }}-${{ github.sha }} \
            -t asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:${{ steps.deployment-env.outputs.ENVIRONMENT }}-latest \
            -f services/${{ matrix.service }}/Dockerfile \
            --build-arg NODE_ENV=${{ steps.deployment-env.outputs.NODE_ENV }} \
            services/${{ matrix.service }}

      - name: Push Docker image
        run: |
          docker push asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:${{ steps.deployment-env.outputs.ENVIRONMENT }}-${{ github.sha }}
          docker push asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:${{ steps.deployment-env.outputs.ENVIRONMENT }}-latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ matrix.service }}${{ steps.deployment-env.outputs.SERVICE_SUFFIX }} \
            --image asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:${{ steps.deployment-env.outputs.ENVIRONMENT }}-${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --service-account ${{ env.SERVICE_ACCOUNT_EMAIL }} \
            --set-env-vars NODE_ENV=${{ steps.deployment-env.outputs.NODE_ENV }} \
            --set-env-vars DATABASE_URL=${{ steps.env-vars.outputs.DATABASE_URL }} \
            --set-env-vars JWT_SECRET=${{ steps.deployment-env.outputs.JWT_SECRET }} \
            --set-env-vars JWT_EXPIRES_IN=${{ steps.deployment-env.outputs.JWT_EXPIRES_IN }} \
            --set-env-vars JWT_REFRESH_SECRET=${{ steps.deployment-env.outputs.JWT_REFRESH_SECRET }} \
            --set-env-vars JWT_REFRESH_EXPIRES_IN=${{ steps.deployment-env.outputs.JWT_REFRESH_EXPIRES_IN }} \
            --set-env-vars REDIS_URL=${{ steps.deployment-env.outputs.REDIS_URL }} \
            --set-env-vars NATS_URL=${{ steps.deployment-env.outputs.NATS_URL }} \
            --min-instances 1 \
            --max-instances 10 \
            --memory 512Mi \
            --cpu 1 \
            --timeout 300

      - name: Get Service URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ matrix.service }}${{ steps.deployment-env.outputs.SERVICE_SUFFIX }} --region=${{ env.REGION }} --format='value(status.url)')
          echo "ðŸš€ [${{ steps.deployment-env.outputs.ENVIRONMENT }}] ${{ matrix.service }} deployed to: $SERVICE_URL"