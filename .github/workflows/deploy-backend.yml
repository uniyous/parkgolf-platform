name: Deploy Backend Services to GCP

on:
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to deploy (comma-separated or "all")'
        required: false
        default: 'all'
      environment:
        description: 'Target environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production

env:
  GCP_PROJECT_ID: uniyous-319808
  REGION: asia-northeast3
  SERVICE_ACCOUNT_EMAIL: parkgolf-services@uniyous-319808.iam.gserviceaccount.com
  NATS_URL: nats://34.64.85.225:4222
  NATS_USER: nats
  NATS_PASSWORD: nats123
  DATABASE_HOST: 34.47.122.22
  DATABASE_PORT: 5432
  DATABASE_USER: postgres
  DATABASE_PASSWORD: postgres123

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.determine-services.outputs.services }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine services to deploy
        id: determine-services
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.services }}" == "all" ]; then
              # Deploy all services including NATS with HTTP health check
              echo "services=[\"auth-service\",\"course-service\",\"booking-service\",\"admin-api\",\"user-api\"]" >> $GITHUB_OUTPUT
            else
              # Convert comma-separated list to JSON array
              services=$(echo "${{ github.event.inputs.services }}" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
              echo "services=$services" >> $GITHUB_OUTPUT
            fi
          else
            # For push events, deploy all services
            echo "services=[\"auth-service\",\"course-service\",\"booking-service\",\"notify-service\",\"admin-api\",\"user-api\"]" >> $GITHUB_OUTPUT
          fi

  deploy-service:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJson(needs.setup.outputs.services) }}
    steps:
      - uses: actions/checkout@v4

      - name: Set deployment environment
        id: deployment-env
        run: |
          SELECTED_ENV="${{ github.event.inputs.environment }}"
          if [[ "$SELECTED_ENV" == "production" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_OUTPUT
            echo "SERVICE_SUFFIX=-prod" >> $GITHUB_OUTPUT
            echo "NODE_ENV=production" >> $GITHUB_OUTPUT
          else
            echo "ENVIRONMENT=development" >> $GITHUB_OUTPUT
            echo "SERVICE_SUFFIX=-dev" >> $GITHUB_OUTPUT
            echo "NODE_ENV=development" >> $GITHUB_OUTPUT
          fi
          echo "ðŸ”§ Selected environment: $SELECTED_ENV"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCP
        run: |
          gcloud auth configure-docker asia-northeast3-docker.pkg.dev --quiet

      - name: Set environment variables for service
        id: env-vars
        run: |
          case "${{ matrix.service }}" in
            auth-service)
              echo "DATABASE_NAME=auth_db" >> $GITHUB_OUTPUT
              echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> $GITHUB_OUTPUT
              echo "REDIS_URL=redis://${{ secrets.REDIS_HOST }}:6379" >> $GITHUB_OUTPUT
              ;;
            course-service)
              echo "DATABASE_NAME=course_db" >> $GITHUB_OUTPUT
              ;;
            booking-service)
              echo "DATABASE_NAME=booking_db" >> $GITHUB_OUTPUT
              ;;
            admin-api)
              echo "REDIS_URL=redis://${{ secrets.REDIS_HOST }}:6379" >> $GITHUB_OUTPUT
              ;;
            user-api)
              echo "REDIS_URL=redis://${{ secrets.REDIS_HOST }}:6379" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Build Docker image
        run: |
          docker build \
            -t asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:${{ steps.deployment-env.outputs.ENVIRONMENT }}-${{ github.sha }} \
            -t asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:${{ steps.deployment-env.outputs.ENVIRONMENT }}-latest \
            -f services/${{ matrix.service }}/Dockerfile \
            --build-arg NODE_ENV=${{ steps.deployment-env.outputs.NODE_ENV }} \
            services/${{ matrix.service }}

      - name: Push Docker image
        run: |
          docker push asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:${{ steps.deployment-env.outputs.ENVIRONMENT }}-${{ github.sha }}
          docker push asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:${{ steps.deployment-env.outputs.ENVIRONMENT }}-latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ matrix.service }}${{ steps.deployment-env.outputs.SERVICE_SUFFIX }} \
            --image asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:${{ steps.deployment-env.outputs.ENVIRONMENT }}-${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --service-account ${{ env.SERVICE_ACCOUNT_EMAIL }} \
            --set-env-vars NODE_ENV=${{ steps.deployment-env.outputs.NODE_ENV }} \
            --set-env-vars NATS_URL=${{ env.NATS_URL }} \
            --set-env-vars NATS_USER=${{ env.NATS_USER }} \
            --set-env-vars NATS_PASSWORD=${{ env.NATS_PASSWORD }} \
            --set-env-vars DATABASE_HOST=${{ env.DATABASE_HOST }} \
            --set-env-vars DATABASE_PORT=${{ env.DATABASE_PORT }} \
            --set-env-vars DATABASE_USER=${{ env.DATABASE_USER }} \
            --set-env-vars DATABASE_PASSWORD=${{ env.DATABASE_PASSWORD }} \
            --set-env-vars DATABASE_NAME=${{ steps.env-vars.outputs.DATABASE_NAME }} \
            --set-env-vars JWT_SECRET=${{ steps.env-vars.outputs.JWT_SECRET }} \
            --set-env-vars REDIS_URL=${{ steps.env-vars.outputs.REDIS_URL }} \
            --set-env-vars SENDGRID_API_KEY=${{ steps.env-vars.outputs.SENDGRID_API_KEY }} \
            --set-env-vars TWILIO_ACCOUNT_SID=${{ steps.env-vars.outputs.TWILIO_ACCOUNT_SID }} \
            --set-env-vars TWILIO_AUTH_TOKEN=${{ steps.env-vars.outputs.TWILIO_AUTH_TOKEN }} \
            --min-instances 1 \
            --max-instances 10 \
            --memory 512Mi \
            --cpu 1 \
            --timeout 300 \
            --container-startup-timeout 300

      - name: Get Service URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ matrix.service }}${{ steps.deployment-env.outputs.SERVICE_SUFFIX }} --region=${{ env.REGION }} --format='value(status.url)')
          echo "ðŸš€ [${{ steps.deployment-env.outputs.ENVIRONMENT }}] ${{ matrix.service }} deployed to: $SERVICE_URL"