name: Deploy Backend Services to GCP

on:
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to deploy (comma-separated or "all")'
        required: false
        default: 'all'
      environment:
        description: 'Target environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production

# Prevent concurrent deployments to same environment
concurrency:
  group: deploy-backend-${{ github.event.inputs.environment || 'development' }}
  cancel-in-progress: true

env:
  GCP_PROJECT_ID: uniyous-319808
  REGION: asia-northeast3
  SERVICE_ACCOUNT_EMAIL: parkgolf-services@uniyous-319808.iam.gserviceaccount.com

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      services: ${{ steps.determine-services.outputs.services }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 1
          clean: true
        timeout-minutes: 10

      - name: Determine services to deploy
        id: determine-services
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.services }}" == "all" ]; then
              # Deploy all services including NATS with HTTP health check
              echo "services=[\"auth-service\",\"course-service\",\"booking-service\",\"admin-api\",\"user-api\"]" >> $GITHUB_OUTPUT
            else
              # Convert comma-separated list to JSON array
              services=$(echo "${{ github.event.inputs.services }}" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
              echo "services=$services" >> $GITHUB_OUTPUT
            fi
          else
            # For push events, deploy all services
            echo "services=[\"auth-service\",\"course-service\",\"booking-service\",\"notify-service\",\"admin-api\",\"user-api\"]" >> $GITHUB_OUTPUT
          fi

  deploy-service:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      matrix:
        service: ${{ fromJson(needs.setup.outputs.services) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 1
          clean: true
        timeout-minutes: 10

      - name: Set deployment environment
        id: deployment-env
        run: |
          SELECTED_ENV="${{ github.event.inputs.environment }}"

          # Parse environment configuration from JSON with error handling
          if [[ "$SELECTED_ENV" == "production" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_OUTPUT
            echo "SERVICE_SUFFIX=-prod" >> $GITHUB_OUTPUT
            echo "NODE_ENV=production" >> $GITHUB_OUTPUT

            # Parse production config JSON
            if [ -n "${{ secrets.PROD_ENV_CONFIG }}" ]; then
              CONFIG_JSON='${{ secrets.PROD_ENV_CONFIG }}'
            else
              CONFIG_JSON='${{ secrets.DEV_ENV_CONFIG }}'
            fi
          else
            echo "ENVIRONMENT=development" >> $GITHUB_OUTPUT
            echo "SERVICE_SUFFIX=-dev" >> $GITHUB_OUTPUT
            echo "NODE_ENV=development" >> $GITHUB_OUTPUT

            # Parse development config JSON
            CONFIG_JSON='${{ secrets.DEV_ENV_CONFIG }}'
          fi

          # Validate and extract environment variables from JSON
          if [ -n "$CONFIG_JSON" ]; then
            echo "ðŸ” Validating JSON configuration..."

            # Use printf to properly handle the JSON string
            printf '%s\n' "$CONFIG_JSON" > /tmp/config.json

            if jq empty /tmp/config.json 2>/dev/null; then
              echo "âœ… JSON is valid, extracting variables..."

              # Extract variables with fallback to empty string for optional fields
              echo "NATS_URL=$(jq -r '.nats.url // ""' /tmp/config.json)" >> $GITHUB_OUTPUT
              echo "NATS_USER=$(jq -r '.nats.user // ""' /tmp/config.json)" >> $GITHUB_OUTPUT
              echo "NATS_PASSWORD=$(jq -r '.nats.password // ""' /tmp/config.json)" >> $GITHUB_OUTPUT
              echo "DATABASE_HOST=$(jq -r '.database.host // ""' /tmp/config.json)" >> $GITHUB_OUTPUT
              echo "DATABASE_PORT=$(jq -r '.database.port // "5432"' /tmp/config.json)" >> $GITHUB_OUTPUT
              echo "DATABASE_USER=$(jq -r '.database.user // "postgres"' /tmp/config.json)" >> $GITHUB_OUTPUT
              echo "DATABASE_PASSWORD=$(jq -r '.database.password // ""' /tmp/config.json)" >> $GITHUB_OUTPUT
              echo "REDIS_HOST=$(jq -r '.redis.host // ""' /tmp/config.json)" >> $GITHUB_OUTPUT
              echo "JWT_SECRET=$(jq -r '.security.jwt_secret // ""' /tmp/config.json)" >> $GITHUB_OUTPUT

              # Clean up temp file
              rm -f /tmp/config.json
            else
              echo "âŒ Invalid JSON format in environment configuration"
              echo "jq error details:"
              jq empty /tmp/config.json 2>&1 || true
              echo "Raw content (first 500 chars):"
              head -c 500 /tmp/config.json
              rm -f /tmp/config.json
              exit 1
            fi
          else
            echo "âŒ No environment configuration found"
            exit 1
          fi

          echo "ðŸ”§ Selected environment: $SELECTED_ENV"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for GCP
        run: |
          gcloud auth configure-docker asia-northeast3-docker.pkg.dev --quiet

      - name: Set environment variables for service
        id: env-vars
        run: |
          # Extract additional service-specific config from JSON
          if [[ "${{ github.event.inputs.environment }}" == "production" ]] && [ -n "${{ secrets.PROD_ENV_CONFIG }}" ]; then
            CONFIG_JSON='${{ secrets.PROD_ENV_CONFIG }}'
          else
            CONFIG_JSON='${{ secrets.DEV_ENV_CONFIG }}'
          fi

          # Extract external service variables from JSON
          if [ -n "$CONFIG_JSON" ]; then
            # Write to temp file for consistent JSON processing
            printf '%s\n' "$CONFIG_JSON" > /tmp/service_config.json

            SENDGRID_API_KEY=$(jq -r '.external_services.sendgrid_api_key // ""' /tmp/service_config.json 2>/dev/null || echo "")
            TWILIO_ACCOUNT_SID=$(jq -r '.external_services.twilio_account_sid // ""' /tmp/service_config.json 2>/dev/null || echo "")
            TWILIO_AUTH_TOKEN=$(jq -r '.external_services.twilio_auth_token // ""' /tmp/service_config.json 2>/dev/null || echo "")

            rm -f /tmp/service_config.json
          fi

          case "${{ matrix.service }}" in
            auth-service)
              echo "DATABASE_NAME=auth_db" >> $GITHUB_OUTPUT
              echo "REDIS_URL=redis://${{ steps.deployment-env.outputs.REDIS_HOST }}:6379" >> $GITHUB_OUTPUT
              ;;
            course-service)
              echo "DATABASE_NAME=course_db" >> $GITHUB_OUTPUT
              ;;
            booking-service)
              echo "DATABASE_NAME=booking_db" >> $GITHUB_OUTPUT
              ;;
            admin-api)
              echo "REDIS_URL=redis://${{ steps.deployment-env.outputs.REDIS_HOST }}:6379" >> $GITHUB_OUTPUT
              ;;
            user-api)
              echo "REDIS_URL=redis://${{ steps.deployment-env.outputs.REDIS_HOST }}:6379" >> $GITHUB_OUTPUT
              ;;
          esac

          # Set external service variables if available and not empty
          if [ -n "$SENDGRID_API_KEY" ] && [ "$SENDGRID_API_KEY" != "null" ] && [ "$SENDGRID_API_KEY" != "" ]; then
            echo "SENDGRID_API_KEY=$SENDGRID_API_KEY" >> $GITHUB_OUTPUT
          else
            echo "SENDGRID_API_KEY=" >> $GITHUB_OUTPUT
          fi
          if [ -n "$TWILIO_ACCOUNT_SID" ] && [ "$TWILIO_ACCOUNT_SID" != "null" ] && [ "$TWILIO_ACCOUNT_SID" != "" ]; then
            echo "TWILIO_ACCOUNT_SID=$TWILIO_ACCOUNT_SID" >> $GITHUB_OUTPUT
          else
            echo "TWILIO_ACCOUNT_SID=" >> $GITHUB_OUTPUT
          fi
          if [ -n "$TWILIO_AUTH_TOKEN" ] && [ "$TWILIO_AUTH_TOKEN" != "null" ] && [ "$TWILIO_AUTH_TOKEN" != "" ]; then
            echo "TWILIO_AUTH_TOKEN=$TWILIO_AUTH_TOKEN" >> $GITHUB_OUTPUT
          else
            echo "TWILIO_AUTH_TOKEN=" >> $GITHUB_OUTPUT
          fi

      - name: Build Docker image
        run: |
          docker build \
            -t asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:${{ steps.deployment-env.outputs.ENVIRONMENT }}-${{ github.sha }} \
            -t asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:${{ steps.deployment-env.outputs.ENVIRONMENT }}-latest \
            -f services/${{ matrix.service }}/Dockerfile \
            --build-arg NODE_ENV=${{ steps.deployment-env.outputs.NODE_ENV }} \
            services/${{ matrix.service }}

      - name: Push Docker image
        run: |
          docker push asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:${{ steps.deployment-env.outputs.ENVIRONMENT }}-${{ github.sha }}
          docker push asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:${{ steps.deployment-env.outputs.ENVIRONMENT }}-latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ matrix.service }}${{ steps.deployment-env.outputs.SERVICE_SUFFIX }} \
            --image asia-northeast3-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/parkgolf/${{ matrix.service }}:${{ steps.deployment-env.outputs.ENVIRONMENT }}-${{ github.sha }} \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --service-account ${{ env.SERVICE_ACCOUNT_EMAIL }} \
            --set-env-vars NODE_ENV=${{ steps.deployment-env.outputs.NODE_ENV }} \
            --set-env-vars NATS_URL=${{ steps.deployment-env.outputs.NATS_URL }} \
            --set-env-vars NATS_USER=${{ steps.deployment-env.outputs.NATS_USER }} \
            --set-env-vars NATS_PASSWORD=${{ steps.deployment-env.outputs.NATS_PASSWORD }} \
            --set-env-vars DATABASE_HOST=${{ steps.deployment-env.outputs.DATABASE_HOST }} \
            --set-env-vars DATABASE_PORT=${{ steps.deployment-env.outputs.DATABASE_PORT }} \
            --set-env-vars DATABASE_USER=${{ steps.deployment-env.outputs.DATABASE_USER }} \
            --set-env-vars DATABASE_PASSWORD=${{ steps.deployment-env.outputs.DATABASE_PASSWORD }} \
            --set-env-vars DATABASE_NAME=${{ steps.env-vars.outputs.DATABASE_NAME }} \
            --set-env-vars JWT_SECRET=${{ steps.deployment-env.outputs.JWT_SECRET }} \
            --set-env-vars REDIS_URL=${{ steps.env-vars.outputs.REDIS_URL }} \
            --set-env-vars SENDGRID_API_KEY=${{ steps.env-vars.outputs.SENDGRID_API_KEY }} \
            --set-env-vars TWILIO_ACCOUNT_SID=${{ steps.env-vars.outputs.TWILIO_ACCOUNT_SID }} \
            --set-env-vars TWILIO_AUTH_TOKEN=${{ steps.env-vars.outputs.TWILIO_AUTH_TOKEN }} \
            --min-instances 1 \
            --max-instances 10 \
            --memory 512Mi \
            --cpu 1 \
            --timeout 300 \
            --container-startup-timeout 300

      - name: Get Service URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ matrix.service }}${{ steps.deployment-env.outputs.SERVICE_SUFFIX }} --region=${{ env.REGION }} --format='value(status.url)')
          echo "ðŸš€ [${{ steps.deployment-env.outputs.ENVIRONMENT }}] ${{ matrix.service }} deployed to: $SERVICE_URL"