name: Deploy Frontend to Firebase Hosting

on:
  workflow_dispatch:
    inputs:
      apps:
        description: 'Apps to deploy (comma-separated or "all")'
        required: false
        default: 'all'
      environment:
        description: 'Target environment'
        required: true
        default: 'development'
        type: choice
        options:
          - development
          - production

env:
  GCP_PROJECT_ID: uniyous-319808

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.determine-apps.outputs.apps }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine apps to deploy
        id: determine-apps
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.apps }}" == "all" ]; then
              echo "apps=[\"admin-dashboard\",\"user-webapp\"]" >> $GITHUB_OUTPUT
            else
              # Convert comma-separated list to JSON array
              apps=$(echo "${{ github.event.inputs.apps }}" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
              echo "apps=$apps" >> $GITHUB_OUTPUT
            fi
          else
            # For push events, deploy all apps
            echo "apps=[\"admin-dashboard\",\"user-webapp\"]" >> $GITHUB_OUTPUT
          fi

  deploy-frontend:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: ${{ fromJson(needs.setup.outputs.apps) }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/${{ matrix.app }}/package-lock.json

      - name: Set deployment environment
        id: deployment-env
        run: |
          SELECTED_ENV="${{ github.event.inputs.environment }}"
          if [[ "$SELECTED_ENV" == "production" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_OUTPUT
            echo "SITE_SUFFIX=" >> $GITHUB_OUTPUT
            echo "API_SUFFIX=-prod" >> $GITHUB_OUTPUT
            echo "APP_ENV=production" >> $GITHUB_OUTPUT
          else
            echo "ENVIRONMENT=development" >> $GITHUB_OUTPUT
            echo "SITE_SUFFIX=-dev" >> $GITHUB_OUTPUT
            echo "API_SUFFIX=-dev" >> $GITHUB_OUTPUT
            echo "APP_ENV=development" >> $GITHUB_OUTPUT
          fi
          echo "ðŸ”§ Selected environment: $SELECTED_ENV"

      - name: Set environment variables
        id: env-vars
        run: |
          case "${{ matrix.app }}" in
            admin-dashboard)
              echo "FIREBASE_SITE=parkgolf-admin${{ steps.deployment-env.outputs.SITE_SUFFIX }}" >> $GITHUB_OUTPUT
              echo "API_URL=https://admin-api${{ steps.deployment-env.outputs.API_SUFFIX }}-${{ secrets.CLOUD_RUN_HASH }}.asia-northeast3.run.app" >> $GITHUB_OUTPUT
              ;;
            user-webapp)
              echo "FIREBASE_SITE=parkgolf-user${{ steps.deployment-env.outputs.SITE_SUFFIX }}" >> $GITHUB_OUTPUT
              echo "API_URL=https://user-api${{ steps.deployment-env.outputs.API_SUFFIX }}-${{ secrets.CLOUD_RUN_HASH }}.asia-northeast3.run.app" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Install dependencies
        working-directory: services/${{ matrix.app }}
        run: npm ci

      - name: Create environment file
        working-directory: services/${{ matrix.app }}
        run: |
          cat > .env.production << EOF
          VITE_API_URL=${{ steps.env-vars.outputs.API_URL }}
          VITE_APP_ENV=${{ steps.deployment-env.outputs.APP_ENV }}
          VITE_GA_TRACKING_ID=${{ secrets.GA_TRACKING_ID }}
          EOF

      - name: Build application
        working-directory: services/${{ matrix.app }}
        run: npm run build

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: ${{ env.GCP_PROJECT_ID }}
          target: ${{ steps.env-vars.outputs.FIREBASE_SITE }}
          entryPoint: services/${{ matrix.app }}

      - name: Get Hosting URL
        run: |
          echo "ðŸš€ [${{ steps.deployment-env.outputs.ENVIRONMENT }}] ${{ matrix.app }} deployed to: https://${{ steps.env-vars.outputs.FIREBASE_SITE }}.web.app"