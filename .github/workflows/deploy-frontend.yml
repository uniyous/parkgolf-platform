name: Deploy Frontend to Firebase Hosting

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'services/admin-dashboard/**'
      - 'services/user-webapp/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:
    inputs:
      apps:
        description: 'Apps to deploy (comma-separated or "all")'
        required: false
        default: 'all'

env:
  GCP_PROJECT_ID: uniyous-319808

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.determine-apps.outputs.apps }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine apps to deploy
        id: determine-apps
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.apps }}" == "all" ]; then
              echo "apps=[\"admin-dashboard\",\"user-webapp\"]" >> $GITHUB_OUTPUT
            else
              # Convert comma-separated list to JSON array
              apps=$(echo "${{ github.event.inputs.apps }}" | sed 's/,/","/g' | sed 's/^/["/' | sed 's/$/"]/')
              echo "apps=$apps" >> $GITHUB_OUTPUT
            fi
          else
            # For push events, deploy all apps
            echo "apps=[\"admin-dashboard\",\"user-webapp\"]" >> $GITHUB_OUTPUT
          fi

  deploy-frontend:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      matrix:
        app: ${{ fromJson(needs.setup.outputs.apps) }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/${{ matrix.app }}/package-lock.json

      - name: Set environment variables
        id: env-vars
        run: |
          case "${{ matrix.app }}" in
            admin-dashboard)
              echo "FIREBASE_SITE=parkgolf-admin" >> $GITHUB_OUTPUT
              echo "API_URL=https://admin-api-${{ secrets.CLOUD_RUN_HASH }}.asia-northeast3.run.app" >> $GITHUB_OUTPUT
              ;;
            user-webapp)
              echo "FIREBASE_SITE=parkgolf-user" >> $GITHUB_OUTPUT
              echo "API_URL=https://user-api-${{ secrets.CLOUD_RUN_HASH }}.asia-northeast3.run.app" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Install dependencies
        working-directory: services/${{ matrix.app }}
        run: npm ci

      - name: Create production environment file
        working-directory: services/${{ matrix.app }}
        run: |
          cat > .env.production << EOF
          VITE_API_URL=${{ steps.env-vars.outputs.API_URL }}
          VITE_APP_ENV=production
          VITE_GA_TRACKING_ID=${{ secrets.GA_TRACKING_ID }}
          EOF

      - name: Build application
        working-directory: services/${{ matrix.app }}
        run: npm run build

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: ${{ env.GCP_PROJECT_ID }}
          target: ${{ steps.env-vars.outputs.FIREBASE_SITE }}
          entryPoint: services/${{ matrix.app }}

      - name: Get Hosting URL
        run: |
          echo "ðŸš€ ${{ matrix.app }} deployed to: https://${{ steps.env-vars.outputs.FIREBASE_SITE }}.web.app"