# GKE Autopilot Cluster Destruction
#
# 이 워크플로우는 GKE Autopilot 클러스터를 삭제합니다.
# 비용 절약을 위해 개발 클러스터를 임시로 삭제할 때 사용합니다.
#
# 주의: 이 작업은 되돌릴 수 없습니다!
# - 클러스터 내 모든 리소스가 삭제됩니다
# - PVC(영구 볼륨)도 삭제됩니다
# - Artifact Registry의 이미지는 보존됩니다
#
# 사용법:
#   Actions > Destroy GKE Cluster > Run workflow
#   - confirm: "destroy" 입력 (확인용)
#   - cluster_name: 삭제할 클러스터 이름

name: Destroy GKE Cluster

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "destroy" to confirm deletion'
        required: true
        type: string
      cluster_name:
        description: 'Cluster name to destroy'
        required: true
        default: 'parkgolf-dev-cluster'
        type: string
      delete_ip:
        description: 'Also delete static IP?'
        required: true
        default: 'yes'
        type: choice
        options:
          - 'yes'
          - 'no'

env:
  REGION: asia-northeast3
  CLUSTER_NAME: ${{ github.event.inputs.cluster_name }}

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      proceed: ${{ steps.validate.outputs.proceed }}
    steps:
      - name: Validate Confirmation
        id: validate
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "destroy" ]; then
            echo "::error::Confirmation failed. You must type 'destroy' to proceed."
            echo "proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "proceed=true" >> $GITHUB_OUTPUT
          echo "Confirmation validated. Proceeding with destruction..."

  destroy:
    needs: validate
    if: needs.validate.outputs.proceed == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Extract Project ID
        run: |
          PROJECT_ID=$(echo '${{ secrets.GCP_SA_KEY }}' | jq -r '.project_id')
          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Check Cluster Exists
        id: check
        run: |
          if gcloud container clusters describe ${{ env.CLUSTER_NAME }} \
            --region=${{ env.REGION }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Cluster '${{ env.CLUSTER_NAME }}' found"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::warning::Cluster '${{ env.CLUSTER_NAME }}' not found"
          fi

      - name: Pre-deletion Summary
        if: steps.check.outputs.exists == 'true'
        run: |
          echo "=========================================="
          echo "       Pre-Deletion Summary               "
          echo "=========================================="
          echo ""
          echo "Cluster: ${{ env.CLUSTER_NAME }}"
          echo "Region: ${{ env.REGION }}"
          echo ""

          # Get credentials to show what will be deleted
          gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} \
            --region=${{ env.REGION }} 2>/dev/null || true

          echo "=== Resources to be deleted ==="
          echo ""
          echo "Namespaces:"
          kubectl get namespaces 2>/dev/null || echo "Unable to list"
          echo ""
          echo "Pods (all namespaces):"
          kubectl get pods --all-namespaces 2>/dev/null || echo "Unable to list"
          echo ""
          echo "PVCs (Persistent Volumes):"
          kubectl get pvc --all-namespaces 2>/dev/null || echo "Unable to list"
          echo ""
          echo "=========================================="

      - name: Delete GKE Cluster
        if: steps.check.outputs.exists == 'true'
        run: |
          echo "Deleting GKE cluster: ${{ env.CLUSTER_NAME }}..."
          echo "This may take 5-10 minutes..."

          gcloud container clusters delete ${{ env.CLUSTER_NAME }} \
            --region=${{ env.REGION }} \
            --quiet

          echo "Cluster deleted successfully"

      - name: Delete Static IP
        if: github.event.inputs.delete_ip == 'yes'
        run: |
          IP_NAME="parkgolf-${{ env.CLUSTER_NAME }}-ip"
          echo "Checking for static IP: $IP_NAME"

          if gcloud compute addresses describe $IP_NAME --global 2>/dev/null; then
            echo "Deleting static IP: $IP_NAME"
            gcloud compute addresses delete $IP_NAME --global --quiet
            echo "Static IP deleted"
          else
            echo "Static IP not found (may not have been created)"
          fi

      - name: Cleanup Summary
        run: |
          echo ""
          echo "=========================================="
          echo "       Cleanup Summary                    "
          echo "=========================================="
          echo ""
          echo "Deleted resources:"
          echo "  - GKE Cluster: ${{ env.CLUSTER_NAME }}"
          if [ "${{ github.event.inputs.delete_ip }}" = "yes" ]; then
            echo "  - Static IP: parkgolf-${{ env.CLUSTER_NAME }}-ip"
          fi
          echo ""
          echo "Preserved resources:"
          echo "  - Artifact Registry: parkgolf (container images)"
          echo "  - GitHub Secrets"
          echo ""
          echo "To recreate the cluster, run:"
          echo "  Actions > GKE Autopilot Infrastructure Setup > Run workflow"
          echo ""
          echo "=========================================="
          echo "Cleanup completed!"
          echo "=========================================="

  # 안전장치: 실수로 production 삭제 방지
  production-guard:
    runs-on: ubuntu-latest
    if: contains(github.event.inputs.cluster_name, 'prod')
    steps:
      - name: Block Production Deletion
        run: |
          echo "::error::Production cluster deletion is blocked for safety."
          echo "If you really need to delete a production cluster,"
          echo "please do it manually via gcloud CLI or GCP Console."
          exit 1
