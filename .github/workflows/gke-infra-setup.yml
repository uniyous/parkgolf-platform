# GKE Autopilot Infrastructure Setup
#
# 이 워크플로우는 GKE Autopilot 클러스터와 기본 인프라(PostgreSQL, NATS)를 구축합니다.
#
# 사전 요구사항:
# 1. GitHub Secrets 설정:
#    - GCP_SA_KEY: 서비스 계정 JSON 키 (container.admin, artifactregistry.admin, compute.admin 권한)
#    - DB_PASSWORD: PostgreSQL 비밀번호
#    - JWT_SECRET: JWT 시크릿 (최소 32자)
#    - JWT_REFRESH_SECRET: JWT 리프레시 시크릿
#
# 사용법:
#   Actions > GKE Autopilot Infrastructure Setup > Run workflow
#   - action: create (클러스터 생성) / update (설정 업데이트) / status (상태 확인)

name: GKE Autopilot Infrastructure Setup

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'create'
        type: choice
        options:
          - create
          - update
          - status
      cluster_name:
        description: 'Cluster name'
        required: true
        default: 'parkgolf-dev-cluster'
        type: string

env:
  REGION: asia-northeast3
  CLUSTER_NAME: ${{ github.event.inputs.cluster_name || 'parkgolf-dev-cluster' }}
  NAMESPACE: parkgolf-dev
  REGISTRY: asia-northeast3-docker.pkg.dev

jobs:
  setup-infrastructure:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate Secrets
        run: |
          if [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "::error::GCP_SA_KEY secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.DB_PASSWORD }}" ]; then
            echo "::error::DB_PASSWORD secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.JWT_SECRET }}" ]; then
            echo "::error::JWT_SECRET secret is not set"
            exit 1
          fi
          echo "All required secrets are configured"

      - name: Extract Project ID from SA Key
        run: |
          PROJECT_ID=$(echo '${{ secrets.GCP_SA_KEY }}' | jq -r '.project_id')
          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
          echo "Project ID: $PROJECT_ID"

      - name: Google Auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
          install_components: 'gke-gcloud-auth-plugin'

      - name: Enable GCP APIs
        run: |
          echo "Enabling required GCP APIs..."
          gcloud services enable container.googleapis.com
          gcloud services enable artifactregistry.googleapis.com
          gcloud services enable compute.googleapis.com
          gcloud services enable cloudresourcemanager.googleapis.com
          echo "APIs enabled successfully"

      - name: Create Artifact Registry
        run: |
          if gcloud artifacts repositories describe parkgolf \
            --location=${{ env.REGION }} 2>/dev/null; then
            echo "Artifact Registry 'parkgolf' already exists"
          else
            echo "Creating Artifact Registry 'parkgolf'..."
            gcloud artifacts repositories create parkgolf \
              --repository-format=docker \
              --location=${{ env.REGION }} \
              --description="Parkgolf container images"
            echo "Artifact Registry created"
          fi

      - name: Check Cluster Status
        id: cluster-check
        run: |
          if gcloud container clusters describe ${{ env.CLUSTER_NAME }} \
            --region=${{ env.REGION }} 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Cluster '${{ env.CLUSTER_NAME }}' exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Cluster '${{ env.CLUSTER_NAME }}' does not exist"
          fi

      - name: Create GKE Autopilot Cluster
        if: steps.cluster-check.outputs.exists == 'false' && github.event.inputs.action == 'create'
        run: |
          echo "=========================================="
          echo "Creating GKE Autopilot cluster: ${{ env.CLUSTER_NAME }}"
          echo "Region: ${{ env.REGION }}"
          echo "=========================================="

          gcloud container clusters create-auto ${{ env.CLUSTER_NAME }} \
            --region=${{ env.REGION }} \
            --release-channel=regular \
            --network=parkgolf-dev \
            --subnetwork=parkgolf-private-dev

          echo "Cluster creation initiated, waiting for it to be ready..."

      - name: Wait for Cluster Ready
        if: github.event.inputs.action == 'create'
        run: |
          echo "Waiting for cluster to be ready (this may take 5-10 minutes)..."
          for i in {1..40}; do
            STATUS=$(gcloud container clusters describe ${{ env.CLUSTER_NAME }} \
              --region=${{ env.REGION }} \
              --format="value(status)" 2>/dev/null || echo "PROVISIONING")
            echo "[$i/40] Cluster status: $STATUS"
            if [ "$STATUS" = "RUNNING" ]; then
              echo "Cluster is ready!"
              break
            fi
            if [ "$STATUS" = "ERROR" ]; then
              echo "::error::Cluster creation failed"
              exit 1
            fi
            sleep 30
          done

      - name: Get GKE Credentials
        run: |
          gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} \
            --region=${{ env.REGION }}
          echo "kubectl configured successfully"

      - name: Create Namespace
        run: |
          kubectl create namespace ${{ env.NAMESPACE }} \
            --dry-run=client -o yaml | kubectl apply -f -
          echo "Namespace '${{ env.NAMESPACE }}' ready"

      - name: Create Secrets
        run: |
          echo "Creating Kubernetes secrets..."
          kubectl create secret generic parkgolf-secrets \
            --namespace=${{ env.NAMESPACE }} \
            --from-literal=POSTGRES_USER=parkgolf \
            --from-literal=POSTGRES_PASSWORD='${{ secrets.DB_PASSWORD }}' \
            --from-literal=JWT_SECRET='${{ secrets.JWT_SECRET }}' \
            --from-literal=JWT_REFRESH_SECRET='${{ secrets.JWT_REFRESH_SECRET }}' \
            --dry-run=client -o yaml | kubectl apply -f -
          echo "Secrets created successfully"

      - name: Create ConfigMap
        run: |
          echo "Creating ConfigMap..."
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: parkgolf-config
            namespace: ${{ env.NAMESPACE }}
          data:
            NODE_ENV: "development"
            NATS_URL: "nats://nats:4222"
            DB_HOST: "postgres"
            DB_PORT: "5432"
            JWT_EXPIRATION: "1h"
            JWT_REFRESH_EXPIRATION: "7d"
          EOF
          echo "ConfigMap created successfully"

      - name: Deploy PostgreSQL
        if: github.event.inputs.action != 'status'
        run: |
          echo "Deploying PostgreSQL..."
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Service
          metadata:
            name: postgres
            namespace: ${{ env.NAMESPACE }}
          spec:
            ports:
            - port: 5432
              targetPort: 5432
            selector:
              app: postgres
            clusterIP: None
          ---
          apiVersion: apps/v1
          kind: StatefulSet
          metadata:
            name: postgres
            namespace: ${{ env.NAMESPACE }}
          spec:
            serviceName: postgres
            replicas: 1
            selector:
              matchLabels:
                app: postgres
            template:
              metadata:
                labels:
                  app: postgres
              spec:
                containers:
                - name: postgres
                  image: postgres:15-alpine
                  ports:
                  - containerPort: 5432
                  env:
                  - name: POSTGRES_USER
                    valueFrom:
                      secretKeyRef:
                        name: parkgolf-secrets
                        key: POSTGRES_USER
                  - name: POSTGRES_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: parkgolf-secrets
                        key: POSTGRES_PASSWORD
                  - name: PGDATA
                    value: /var/lib/postgresql/data/pgdata
                  resources:
                    requests:
                      cpu: "250m"
                      memory: "512Mi"
                    limits:
                      cpu: "1000m"
                      memory: "1Gi"
                  volumeMounts:
                  - name: postgres-data
                    mountPath: /var/lib/postgresql/data
                  readinessProbe:
                    exec:
                      command: ["pg_isready", "-U", "parkgolf"]
                    initialDelaySeconds: 10
                    periodSeconds: 5
                  livenessProbe:
                    exec:
                      command: ["pg_isready", "-U", "parkgolf"]
                    initialDelaySeconds: 30
                    periodSeconds: 10
            volumeClaimTemplates:
            - metadata:
                name: postgres-data
              spec:
                accessModes: ["ReadWriteOnce"]
                storageClassName: standard-rwo
                resources:
                  requests:
                    storage: 10Gi
          EOF
          echo "PostgreSQL deployment applied"

      - name: Wait for PostgreSQL
        if: github.event.inputs.action != 'status'
        run: |
          echo "Waiting for PostgreSQL to be ready..."
          kubectl wait --for=condition=ready pod -l app=postgres \
            -n ${{ env.NAMESPACE }} --timeout=300s
          echo "PostgreSQL is ready"

      - name: Initialize Databases
        if: github.event.inputs.action == 'create'
        run: |
          echo "Initializing databases..."
          kubectl run postgres-init-${{ github.run_id }} \
            --rm -i --restart=Never \
            --namespace=${{ env.NAMESPACE }} \
            --image=postgres:15-alpine \
            --env="PGHOST=postgres" \
            --env="PGUSER=parkgolf" \
            --env="PGPASSWORD=${{ secrets.DB_PASSWORD }}" \
            -- sh -c "
              echo 'Waiting for PostgreSQL...'
              until pg_isready -h postgres; do sleep 2; done
              echo 'Creating databases...'
              psql -h postgres -c 'CREATE DATABASE iam_db;' 2>/dev/null || echo 'iam_db exists'
              psql -h postgres -c 'CREATE DATABASE course_db;' 2>/dev/null || echo 'course_db exists'
              psql -h postgres -c 'CREATE DATABASE booking_db;' 2>/dev/null || echo 'booking_db exists'
              psql -h postgres -c 'CREATE DATABASE chat_db;' 2>/dev/null || echo 'chat_db exists'
              psql -h postgres -c 'CREATE DATABASE notify_db;' 2>/dev/null || echo 'notify_db exists'
              echo 'Databases initialized successfully'
            "

      - name: Deploy NATS
        if: github.event.inputs.action != 'status'
        run: |
          echo "Deploying NATS..."
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: Service
          metadata:
            name: nats
            namespace: ${{ env.NAMESPACE }}
          spec:
            ports:
            - name: client
              port: 4222
              targetPort: 4222
            - name: monitor
              port: 8222
              targetPort: 8222
            selector:
              app: nats
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: nats
            namespace: ${{ env.NAMESPACE }}
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: nats
            template:
              metadata:
                labels:
                  app: nats
              spec:
                containers:
                - name: nats
                  image: nats:2.10-alpine
                  args: ["-js", "-m", "8222"]
                  ports:
                  - containerPort: 4222
                    name: client
                  - containerPort: 8222
                    name: monitor
                  resources:
                    requests:
                      cpu: "100m"
                      memory: "128Mi"
                    limits:
                      cpu: "300m"
                      memory: "256Mi"
                  readinessProbe:
                    httpGet:
                      path: /healthz
                      port: 8222
                    initialDelaySeconds: 5
                    periodSeconds: 5
                  livenessProbe:
                    httpGet:
                      path: /healthz
                      port: 8222
                    initialDelaySeconds: 10
                    periodSeconds: 10
          EOF
          echo "NATS deployment applied"

      - name: Wait for NATS
        if: github.event.inputs.action != 'status'
        run: |
          echo "Waiting for NATS to be ready..."
          kubectl wait --for=condition=ready pod -l app=nats \
            -n ${{ env.NAMESPACE }} --timeout=120s
          echo "NATS is ready"

      - name: Infrastructure Status
        run: |
          echo ""
          echo "=========================================="
          echo "       GKE Autopilot Infrastructure       "
          echo "=========================================="
          echo ""
          echo "Cluster: ${{ env.CLUSTER_NAME }}"
          echo "Region: ${{ env.REGION }}"
          echo "Namespace: ${{ env.NAMESPACE }}"
          echo ""
          echo "=== Cluster Info ==="
          kubectl cluster-info
          echo ""
          echo "=== Nodes (Autopilot manages these) ==="
          kubectl get nodes
          echo ""
          echo "=== Pods ==="
          kubectl get pods -n ${{ env.NAMESPACE }} -o wide
          echo ""
          echo "=== Services ==="
          kubectl get svc -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== PVC (Storage) ==="
          kubectl get pvc -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== Secrets ==="
          kubectl get secrets -n ${{ env.NAMESPACE }}
          echo ""
          echo "=== ConfigMaps ==="
          kubectl get configmaps -n ${{ env.NAMESPACE }}
          echo ""
          echo "=========================================="
          echo "Infrastructure setup completed!"
          echo "=========================================="
