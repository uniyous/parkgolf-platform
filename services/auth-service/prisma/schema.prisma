// Schema v3 - Role-based permissions (2025-12-26)
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int              @id @default(autoincrement())
  email         String           @unique
  password      String
  name          String?
  roleCode      String           @default("USER") @map("role_code") // RoleMaster 참조 (필수)
  isActive      Boolean          @default(true) @map("is_active")
  createdAt     DateTime         @default(now()) @map("created_at")
  updatedAt     DateTime         @updatedAt @map("updated_at")

  // 관계
  role          RoleMaster       @relation(fields: [roleCode], references: [code])
  refreshTokens RefreshToken[]

  @@index([roleCode])
  @@index([isActive])
  @@map("users")
}

model RefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int      @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model Admin {
  id            Int                 @id @default(autoincrement())
  email         String              @unique
  password      String
  name          String
  roleCode      String              @default("VIEWER") @map("role_code") // RoleMaster 참조 (필수)
  phone         String?
  department    String?
  description   String?
  isActive      Boolean             @default(true) @map("is_active")
  lastLoginAt   DateTime?           @map("last_login_at")
  createdAt     DateTime            @default(now()) @map("created_at")
  updatedAt     DateTime            @updatedAt @map("updated_at")

  // 관계
  role          RoleMaster          @relation(fields: [roleCode], references: [code])
  activityLogs  AdminActivityLog[]
  refreshTokens AdminRefreshToken[]

  @@index([roleCode])
  @@index([isActive])
  @@index([createdAt])
  @@map("admins")
}

model AdminRefreshToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  adminId   Int      @map("admin_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  admin     Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("admin_refresh_tokens")
}



// 권한 마스터 테이블
model PermissionMaster {
  code        String   @id // 권한 코드 PK (예: 'BOOKING_CREATE')
  name        String   // 권한 이름 (예: '예약 생성')
  description String?  // 권한 설명
  category    String   // 권한 카테고리 (예: 'BOOKING', 'PROFILE', 'COURSE')
  level       String   @default("low") // 권한 레벨 (low, medium, high)
  isActive    Boolean  @default(true) @map("is_active") // 활성화 여부
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // 관계
  rolePermissions RolePermission[]

  @@map("permission_masters")
}

// 역할 마스터 테이블  
model RoleMaster {
  code        String   @id // 역할 코드 PK (예: 'USER', 'ADMIN')
  name        String   // 역할 이름 (예: '일반 사용자', '관리자')
  description String?  // 역할 설명
  userType    String   @map("user_type") // 사용자 유형 ('USER' 또는 'ADMIN')
  level       Int      @default(1) // 역할 레벨 (숫자가 높을수록 상위)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  // 관계
  users           User[]
  admins          Admin[]
  rolePermissions RolePermission[]

  @@map("role_masters")
}

// 역할-권한 매핑 테이블
model RolePermission {
  roleCode       String           @map("role_code")
  permissionCode String           @map("permission_code")
  createdAt      DateTime         @default(now()) @map("created_at")
  
  role           RoleMaster       @relation(fields: [roleCode], references: [code], onDelete: Cascade)
  permission     PermissionMaster @relation(fields: [permissionCode], references: [code], onDelete: Cascade)

  @@id([roleCode, permissionCode])
  @@index([roleCode])
  @@index([permissionCode])
  @@map("role_permissions")
}

model AdminActivityLog {
  id        Int      @id @default(autoincrement())
  adminId   Int      @map("admin_id")
  action    String
  resource  String?
  details   Json?
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")
  admin     Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([createdAt])
  @@map("admin_activity_logs")
}
