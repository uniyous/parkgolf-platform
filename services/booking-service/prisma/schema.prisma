// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Booking {
  id                    Int           @id @default(autoincrement())

  // Game 기반 예약 (course-service의 GameTimeSlot 참조)
  gameTimeSlotId        Int           @map("game_time_slot_id") // course-service의 GameTimeSlot ID
  gameId                Int           @map("game_id") // course-service의 Game ID

  // 캐시된 Game 정보 (성능 최적화용)
  gameName              String?       @map("game_name") // 게임 조합명 (예: "A+B 코스")
  gameCode              String?       @map("game_code") // 게임 코드

  // 캐시된 코스 정보
  frontNineCourseId     Int?          @map("front_nine_course_id") // 전반 9홀 코스 ID
  frontNineCourseName   String?       @map("front_nine_course_name") // 전반 코스명 (캐시)
  backNineCourseId      Int?          @map("back_nine_course_id") // 후반 9홀 코스 ID
  backNineCourseName    String?       @map("back_nine_course_name") // 후반 코스명 (캐시)

  // 예약 시간 정보
  bookingDate           DateTime      @map("booking_date") // 예약 날짜
  startTime             String        @map("start_time") // 시작 시간 (HH:MM)
  endTime               String        @map("end_time") // 종료 시간 (HH:MM)

  // 클럽 정보 캐시
  clubId                Int?          @map("club_id")
  clubName              String?       @map("club_name")

  // 예약자 정보
  userId                Int?          @map("user_id") // 등록된 사용자 (null이면 비회원)
  guestName             String?       @map("guest_name") // 비회원 예약자명
  guestEmail            String?       @map("guest_email") // 비회원 이메일
  guestPhone            String?       @map("guest_phone") // 비회원 전화번호

  // 예약 상세 정보
  playerCount           Int           @default(1) @map("player_count")
  pricePerPerson        Decimal       @db.Decimal(10, 2) @map("price_per_person")
  serviceFee            Decimal       @db.Decimal(10, 2) @default(0) @map("service_fee")
  totalPrice            Decimal       @db.Decimal(10, 2) @map("total_price")
  status                BookingStatus @default(PENDING)

  // 결제 정보
  paymentMethod         String?       @map("payment_method") // card, kakaopay, naverpay, tosspay, bank

  // 메타 정보
  specialRequests       String?       @map("special_requests") // 특별 요청사항
  bookingNumber         String        @unique @map("booking_number") // BK-XXXXXXXX-XXXX 형식
  idempotencyKey        String?       @unique @map("idempotency_key") // 멱등성 키
  notes                 String?       // 관리자 메모

  // Saga 관련
  sagaFailReason        String?       @map("saga_fail_reason") // 실패 사유

  // 캐시된 사용자 정보 (성능 최적화용)
  userEmail             String?       @map("user_email") // 사용자 이메일
  userName              String?       @map("user_name") // 사용자 이름
  userPhone             String?       @map("user_phone") // 사용자 전화번호

  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  // Relations
  payments              Payment[]
  histories             BookingHistory[]

  @@index([userId])
  @@index([gameTimeSlotId])
  @@index([gameId])
  @@index([clubId])
  @@index([frontNineCourseId, backNineCourseId])
  @@index([bookingDate])
  @@index([bookingNumber])
  @@index([status])
  @@map("bookings")
}

model Payment {
  id            Int           @id @default(autoincrement())
  bookingId     Int           @map("booking_id")
  booking       Booking       @relation(fields: [bookingId], references: [id])
  amount        Decimal       @db.Decimal(10, 2)
  paymentMethod String        @map("payment_method")
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")
  transactionId String?       @map("transaction_id")
  paidAt        DateTime?     @map("paid_at")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  @@map("payments")
}

model BookingHistory {
  id        Int      @id @default(autoincrement())
  bookingId Int      @map("booking_id")
  booking   Booking  @relation(fields: [bookingId], references: [id])
  action    String   // CREATED, UPDATED, CANCELLED, etc.
  details   Json?
  userId    Int      @map("user_id") // 작업 수행한 사용자
  createdAt DateTime @default(now()) @map("created_at")

  @@index([bookingId])
  @@map("booking_history")
}

// Game 정보 캐시 (course-service에서 동기화)
model GameCache {
  id                   Int      @id @default(autoincrement())
  gameId               Int      @unique @map("game_id") // course-service의 Game ID
  name                 String   // 게임명 (예: "A+B 코스")
  code                 String   // 게임 코드
  description          String?

  // 코스 정보
  frontNineCourseId    Int      @map("front_nine_course_id")
  frontNineCourseName  String   @map("front_nine_course_name")
  backNineCourseId     Int      @map("back_nine_course_id")
  backNineCourseName   String   @map("back_nine_course_name")

  // 게임 설정
  totalHoles           Int      @default(18) @map("total_holes")
  estimatedDuration    Int      @default(180) @map("estimated_duration")
  breakDuration        Int      @default(10) @map("break_duration")
  maxPlayers           Int      @default(4) @map("max_players")

  // 가격
  basePrice            Decimal  @db.Decimal(10, 2) @map("base_price")
  weekendPrice         Decimal? @db.Decimal(10, 2) @map("weekend_price")
  holidayPrice         Decimal? @db.Decimal(10, 2) @map("holiday_price")

  // 클럽 정보
  clubId               Int      @map("club_id")
  clubName             String   @map("club_name")

  // 상태
  isActive             Boolean  @default(true) @map("is_active")
  lastSyncAt           DateTime @default(now()) @map("last_sync_at")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@index([clubId])
  @@map("game_cache")
}

// GameTimeSlot 가용성 캐시 (course-service와 동기화)
model GameTimeSlotCache {
  id                   Int      @id @default(autoincrement())

  // course-service의 GameTimeSlot 참조
  gameTimeSlotId       Int      @unique @map("game_time_slot_id")
  gameId               Int      @map("game_id")

  // 캐시된 게임 정보
  gameName             String?  @map("game_name")
  gameCode             String?  @map("game_code")
  frontNineCourseName  String?  @map("front_nine_course_name")
  backNineCourseName   String?  @map("back_nine_course_name")
  clubId               Int?     @map("club_id")
  clubName             String?  @map("club_name")

  // 시간 정보
  date                 DateTime @db.Date
  startTime            String   @map("start_time") // HH:MM format
  endTime              String   @map("end_time") // HH:MM format

  // 가용성 정보
  maxPlayers           Int      @default(4) @map("max_players")
  bookedPlayers        Int      @default(0) @map("booked_players")
  availablePlayers     Int      @default(4) @map("available_players") // maxPlayers - bookedPlayers
  isAvailable          Boolean  @default(true) @map("is_available")

  // 가격 정보
  price                Decimal  @db.Decimal(10, 2)
  isPremium            Boolean  @default(false) @map("is_premium")

  // 상태
  status               String   @default("AVAILABLE") // AVAILABLE, FULLY_BOOKED, CLOSED, MAINTENANCE

  // 메타데이터
  lastSyncAt           DateTime @default(now()) @map("last_sync_at")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@index([gameId])
  @@index([clubId])
  @@index([date])
  @@index([date, startTime])
  @@index([isAvailable])
  @@index([status])
  @@map("game_time_slot_cache")
}

enum BookingStatus {
  PENDING           // Saga 시작: 예약 생성됨, 슬롯 예약 대기 중
  SLOT_RESERVED     // course-service에서 슬롯 예약 완료
  CONFIRMED         // 최종 확정 (결제 완료 등)
  CANCELLED         // 취소됨
  COMPLETED         // 완료됨
  NO_SHOW           // 노쇼
  FAILED            // Saga 실패 (슬롯 예약 실패 등)
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// =====================================================
// Saga 패턴 지원 모델
// =====================================================

// Transactional Outbox 패턴: 이벤트 발행 보장
model OutboxEvent {
  id            Int      @id @default(autoincrement())

  // 이벤트 정보
  aggregateType String   @map("aggregate_type")  // 예: "Booking"
  aggregateId   String   @map("aggregate_id")    // 예: booking.id
  eventType     String   @map("event_type")      // 예: "slot.reserve"
  payload       Json                              // 이벤트 페이로드

  // 처리 상태
  status        OutboxStatus @default(PENDING)
  retryCount    Int          @default(0) @map("retry_count")
  lastError     String?      @map("last_error")

  // 타임스탬프
  createdAt     DateTime @default(now()) @map("created_at")
  processedAt   DateTime? @map("processed_at")

  @@index([status, createdAt])
  @@index([aggregateType, aggregateId])
  @@map("outbox_events")
}

enum OutboxStatus {
  PENDING      // 발행 대기
  PROCESSING   // 발행 중
  SENT         // 발행 완료
  FAILED       // 발행 실패 (재시도 한도 초과)
}

// 멱등성 키: 중복 요청 방지
model IdempotencyKey {
  id            Int      @id @default(autoincrement())

  key           String   @unique                  // 클라이언트가 전송한 고유 키
  aggregateType String   @map("aggregate_type")   // 예: "Booking"
  aggregateId   String?  @map("aggregate_id")     // 처리 완료된 리소스 ID

  // 응답 캐시 (동일 요청 시 반환)
  responseStatus Int?    @map("response_status")
  responseBody   Json?   @map("response_body")

  // 타임스탬프
  createdAt     DateTime @default(now()) @map("created_at")
  expiresAt     DateTime @map("expires_at")       // TTL (예: 24시간)

  @@index([key])
  @@index([expiresAt])
  @@map("idempotency_keys")
}

// =====================================================
// 정책 관리 모델 (취소/환불/노쇼)
// =====================================================

// 취소 정책
model CancellationPolicy {
  id                      Int      @id @default(autoincrement())

  name                    String   // 정책명 (예: "기본 취소 정책")
  code                    String   @unique // 정책 코드 (예: "DEFAULT_CANCEL")
  description             String?  // 정책 설명

  // 취소 허용 설정
  allowUserCancel         Boolean  @default(true) @map("allow_user_cancel") // 고객 취소 허용
  userCancelDeadlineHours Int      @default(72) @map("user_cancel_deadline_hours") // 취소 마감 시간 (예약 시간 기준)
  allowSameDayCancel      Boolean  @default(false) @map("allow_same_day_cancel") // 당일 취소 허용

  // 상태
  isDefault               Boolean  @default(false) @map("is_default") // 기본 정책 여부
  isActive                Boolean  @default(true) @map("is_active")

  // 적용 범위 (null이면 전체 적용)
  clubId                  Int?     @map("club_id") // 특정 골프장에만 적용

  createdAt               DateTime @default(now()) @map("created_at")
  updatedAt               DateTime @updatedAt @map("updated_at")

  @@index([isDefault])
  @@index([isActive])
  @@index([clubId])
  @@map("cancellation_policies")
}

// 환불 정책
model RefundPolicy {
  id                     Int           @id @default(autoincrement())

  name                   String        // 정책명 (예: "기본 환불 정책")
  code                   String        @unique // 정책 코드
  description            String?       // 정책 설명

  // 관리자/시스템 취소 시 환불율
  adminCancelRefundRate  Int           @default(100) @map("admin_cancel_refund_rate") // 관리자 취소 환불율 (%)
  systemCancelRefundRate Int           @default(100) @map("system_cancel_refund_rate") // 시스템 취소 환불율 (%)

  // 최소 환불 금액 및 수수료
  minRefundAmount        Int           @default(0) @map("min_refund_amount") // 최소 환불 금액
  refundFee              Int           @default(0) @map("refund_fee") // 환불 수수료 (고정)
  refundFeeRate          Int           @default(0) @map("refund_fee_rate") // 환불 수수료율 (%)

  // 상태
  isDefault              Boolean       @default(false) @map("is_default")
  isActive               Boolean       @default(true) @map("is_active")

  // 적용 범위
  clubId                 Int?          @map("club_id")

  createdAt              DateTime      @default(now()) @map("created_at")
  updatedAt              DateTime      @updatedAt @map("updated_at")

  // Relations
  tiers                  RefundTier[]

  @@index([isDefault])
  @@index([isActive])
  @@index([clubId])
  @@map("refund_policies")
}

// 환불율 티어 (시점별 환불율)
model RefundTier {
  id              Int          @id @default(autoincrement())

  refundPolicyId  Int          @map("refund_policy_id")
  refundPolicy    RefundPolicy @relation(fields: [refundPolicyId], references: [id], onDelete: Cascade)

  // 적용 조건 (예약 시간 기준 남은 시간)
  minHoursBefore  Int          @map("min_hours_before") // 최소 시간 (예: 24)
  maxHoursBefore  Int?         @map("max_hours_before") // 최대 시간 (null이면 무제한)

  // 환불율
  refundRate      Int          @map("refund_rate") // 환불율 (%)

  // 설명
  label           String?      // 표시용 라벨 (예: "7일 전")

  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  @@index([refundPolicyId])
  @@map("refund_tiers")
}

// 노쇼 정책
model NoShowPolicy {
  id                    Int              @id @default(autoincrement())

  name                  String           // 정책명
  code                  String           @unique // 정책 코드
  description           String?          // 정책 설명

  // 노쇼 처리 설정
  allowRefundOnNoShow   Boolean          @default(false) @map("allow_refund_on_noshow") // 노쇼 시 환불 허용
  noShowGraceMinutes    Int              @default(30) @map("noshow_grace_minutes") // 노쇼 판정 유예 시간 (분)

  // 페널티 카운트 리셋
  countResetDays        Int              @default(365) @map("count_reset_days") // 노쇼 카운트 리셋 기간 (일)

  // 상태
  isDefault             Boolean          @default(false) @map("is_default")
  isActive              Boolean          @default(true) @map("is_active")

  // 적용 범위
  clubId                Int?             @map("club_id")

  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")

  // Relations
  penalties             NoShowPenalty[]

  @@index([isDefault])
  @@index([isActive])
  @@index([clubId])
  @@map("noshow_policies")
}

// 노쇼 페널티 단계
model NoShowPenalty {
  id              Int           @id @default(autoincrement())

  noShowPolicyId  Int           @map("noshow_policy_id")
  noShowPolicy    NoShowPolicy  @relation(fields: [noShowPolicyId], references: [id], onDelete: Cascade)

  // 적용 조건 (노쇼 횟수)
  minCount        Int           @map("min_count") // 최소 노쇼 횟수 (예: 1)
  maxCount        Int?          @map("max_count") // 최대 노쇼 횟수 (null이면 무제한)

  // 페널티 유형
  penaltyType     NoShowPenaltyType @map("penalty_type")

  // 페널티 상세
  restrictionDays Int?          @map("restriction_days") // 예약 제한 기간 (일)
  feeAmount       Int?          @map("fee_amount") // 위약금 (원)
  feeRate         Int?          @map("fee_rate") // 위약금율 (%)

  // 설명
  label           String?       // 표시용 라벨 (예: "1회 노쇼")
  message         String?       // 안내 메시지

  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  @@index([noShowPolicyId])
  @@map("noshow_penalties")
}

enum NoShowPenaltyType {
  WARNING          // 경고
  RESTRICTION      // 예약 제한
  FEE              // 위약금
  BLACKLIST        // 블랙리스트
}

// 환불 레코드
model Refund {
  id               Int          @id @default(autoincrement())

  // 예약/결제 연결
  bookingId        Int          @map("booking_id")
  paymentId        Int?         @map("payment_id")

  // 환불 정보
  originalAmount   Decimal      @db.Decimal(10, 2) @map("original_amount") // 원래 결제 금액
  refundAmount     Decimal      @db.Decimal(10, 2) @map("refund_amount") // 환불 금액
  refundRate       Int          @map("refund_rate") // 적용된 환불율 (%)
  refundFee        Decimal      @db.Decimal(10, 2) @default(0) @map("refund_fee") // 수수료

  // 상태
  status           RefundStatus @default(REQUESTED)

  // 취소 유형
  cancellationType CancellationType @map("cancellation_type")
  cancelReason     String?      @map("cancel_reason") // 취소 사유
  cancelledBy      Int?         @map("cancelled_by") // 취소 처리자 (admin/user ID)
  cancelledByType  String?      @map("cancelled_by_type") // ADMIN, USER, SYSTEM

  // PG 연동 정보
  pgTransactionId  String?      @map("pg_transaction_id") // PG사 환불 거래 ID
  pgRefundId       String?      @map("pg_refund_id") // PG사 환불 ID

  // 처리 정보
  processedAt      DateTime?    @map("processed_at") // 환불 처리 완료 시간
  processedBy      Int?         @map("processed_by") // 환불 처리자
  rejectedReason   String?      @map("rejected_reason") // 거절 사유

  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  @@index([bookingId])
  @@index([paymentId])
  @@index([status])
  @@index([cancellationType])
  @@map("refunds")
}

enum RefundStatus {
  REQUESTED        // 환불 요청됨
  PENDING          // 환불 대기 (관리자 검토 중)
  APPROVED         // 환불 승인됨
  PROCESSING       // 환불 처리 중
  COMPLETED        // 환불 완료
  REJECTED         // 환불 거절
}

enum CancellationType {
  USER_NORMAL      // 고객 정상 취소 (마감 시한 이전)
  USER_LATE        // 고객 지연 취소 (1~3일 전)
  USER_LASTMINUTE  // 고객 긴급 취소 (24시간 이내)
  ADMIN            // 관리자 취소
  SYSTEM           // 시스템 취소 (Saga 실패 등)
}

// 사용자 노쇼 기록
model UserNoShowRecord {
  id           Int      @id @default(autoincrement())

  userId       Int      @map("user_id")
  bookingId    Int      @map("booking_id")

  // 노쇼 처리 정보
  noShowAt     DateTime @map("noshow_at") // 노쇼 처리 시간
  processedBy  Int?     @map("processed_by") // 처리자
  notes        String?  // 메모

  // 리셋 여부
  isReset      Boolean  @default(false) @map("is_reset") // 카운트에서 제외 여부
  resetAt      DateTime? @map("reset_at")
  resetBy      Int?     @map("reset_by")
  resetReason  String?  @map("reset_reason")

  createdAt    DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([bookingId])
  @@index([noShowAt])
  @@map("user_noshow_records")
}
