// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Booking {
  id                    Int           @id @default(autoincrement())

  // Game 기반 예약 (course-service의 GameTimeSlot 참조)
  gameTimeSlotId        Int           @map("game_time_slot_id") // course-service의 GameTimeSlot ID
  gameId                Int           @map("game_id") // course-service의 Game ID

  // 캐시된 Game 정보 (성능 최적화용)
  gameName              String?       @map("game_name") // 게임 조합명 (예: "A+B 코스")
  gameCode              String?       @map("game_code") // 게임 코드

  // 캐시된 코스 정보
  frontNineCourseId     Int?          @map("front_nine_course_id") // 전반 9홀 코스 ID
  frontNineCourseName   String?       @map("front_nine_course_name") // 전반 코스명 (캐시)
  backNineCourseId      Int?          @map("back_nine_course_id") // 후반 9홀 코스 ID
  backNineCourseName    String?       @map("back_nine_course_name") // 후반 코스명 (캐시)

  // 예약 시간 정보
  bookingDate           DateTime      @map("booking_date") // 예약 날짜
  startTime             String        @map("start_time") // 시작 시간 (HH:MM)
  endTime               String        @map("end_time") // 종료 시간 (HH:MM)

  // 클럽 정보 캐시
  clubId                Int?          @map("club_id")
  clubName              String?       @map("club_name")

  // 예약자 정보
  userId                Int?          @map("user_id") // 등록된 사용자 (null이면 비회원)
  guestName             String?       @map("guest_name") // 비회원 예약자명
  guestEmail            String?       @map("guest_email") // 비회원 이메일
  guestPhone            String?       @map("guest_phone") // 비회원 전화번호

  // 예약 상세 정보
  playerCount           Int           @default(1) @map("player_count")
  pricePerPerson        Decimal       @db.Decimal(10, 2) @map("price_per_person")
  serviceFee            Decimal       @db.Decimal(10, 2) @default(0) @map("service_fee")
  totalPrice            Decimal       @db.Decimal(10, 2) @map("total_price")
  status                BookingStatus @default(PENDING)

  // 결제 정보
  paymentMethod         String?       @map("payment_method") // card, kakaopay, naverpay, tosspay, bank

  // 메타 정보
  specialRequests       String?       @map("special_requests") // 특별 요청사항
  bookingNumber         String        @unique @map("booking_number") // BK-XXXXXXXX-XXXX 형식
  notes                 String?       // 관리자 메모

  // 캐시된 사용자 정보 (성능 최적화용)
  userEmail             String?       @map("user_email") // 사용자 이메일
  userName              String?       @map("user_name") // 사용자 이름
  userPhone             String?       @map("user_phone") // 사용자 전화번호

  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  // Relations
  payments              Payment[]
  histories             BookingHistory[]

  @@index([userId])
  @@index([gameTimeSlotId])
  @@index([gameId])
  @@index([clubId])
  @@index([frontNineCourseId, backNineCourseId])
  @@index([bookingDate])
  @@index([bookingNumber])
  @@index([status])
  @@map("bookings")
}

model Payment {
  id            Int           @id @default(autoincrement())
  bookingId     Int           @map("booking_id")
  booking       Booking       @relation(fields: [bookingId], references: [id])
  amount        Decimal       @db.Decimal(10, 2)
  paymentMethod String        @map("payment_method")
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")
  transactionId String?       @map("transaction_id")
  paidAt        DateTime?     @map("paid_at")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  @@map("payments")
}

model BookingHistory {
  id        Int      @id @default(autoincrement())
  bookingId Int      @map("booking_id")
  booking   Booking  @relation(fields: [bookingId], references: [id])
  action    String   // CREATED, UPDATED, CANCELLED, etc.
  details   Json?
  userId    Int      @map("user_id") // 작업 수행한 사용자
  createdAt DateTime @default(now()) @map("created_at")

  @@index([bookingId])
  @@map("booking_history")
}

// Game 정보 캐시 (course-service에서 동기화)
model GameCache {
  id                   Int      @id @default(autoincrement())
  gameId               Int      @unique @map("game_id") // course-service의 Game ID
  name                 String   // 게임명 (예: "A+B 코스")
  code                 String   // 게임 코드
  description          String?

  // 코스 정보
  frontNineCourseId    Int      @map("front_nine_course_id")
  frontNineCourseName  String   @map("front_nine_course_name")
  backNineCourseId     Int      @map("back_nine_course_id")
  backNineCourseName   String   @map("back_nine_course_name")

  // 게임 설정
  totalHoles           Int      @default(18) @map("total_holes")
  estimatedDuration    Int      @default(180) @map("estimated_duration")
  breakDuration        Int      @default(10) @map("break_duration")
  maxPlayers           Int      @default(4) @map("max_players")

  // 가격
  basePrice            Decimal  @db.Decimal(10, 2) @map("base_price")
  weekendPrice         Decimal? @db.Decimal(10, 2) @map("weekend_price")
  holidayPrice         Decimal? @db.Decimal(10, 2) @map("holiday_price")

  // 클럽 정보
  clubId               Int      @map("club_id")
  clubName             String   @map("club_name")

  // 상태
  isActive             Boolean  @default(true) @map("is_active")
  lastSyncAt           DateTime @default(now()) @map("last_sync_at")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@index([clubId])
  @@map("game_cache")
}

// GameTimeSlot 가용성 캐시 (course-service와 동기화)
model GameTimeSlotCache {
  id                   Int      @id @default(autoincrement())

  // course-service의 GameTimeSlot 참조
  gameTimeSlotId       Int      @unique @map("game_time_slot_id")
  gameId               Int      @map("game_id")

  // 캐시된 게임 정보
  gameName             String?  @map("game_name")
  gameCode             String?  @map("game_code")
  frontNineCourseName  String?  @map("front_nine_course_name")
  backNineCourseName   String?  @map("back_nine_course_name")
  clubId               Int?     @map("club_id")
  clubName             String?  @map("club_name")

  // 시간 정보
  date                 DateTime @db.Date
  startTime            String   @map("start_time") // HH:MM format
  endTime              String   @map("end_time") // HH:MM format

  // 가용성 정보
  maxPlayers           Int      @default(4) @map("max_players")
  bookedPlayers        Int      @default(0) @map("booked_players")
  availablePlayers     Int      @default(4) @map("available_players") // maxPlayers - bookedPlayers
  isAvailable          Boolean  @default(true) @map("is_available")

  // 가격 정보
  price                Decimal  @db.Decimal(10, 2)
  isPremium            Boolean  @default(false) @map("is_premium")

  // 상태
  status               String   @default("AVAILABLE") // AVAILABLE, FULLY_BOOKED, CLOSED, MAINTENANCE

  // 메타데이터
  lastSyncAt           DateTime @default(now()) @map("last_sync_at")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")

  @@index([gameId])
  @@index([clubId])
  @@index([date])
  @@index([date, startTime])
  @@index([isAvailable])
  @@index([status])
  @@map("game_time_slot_cache")
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}
