// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Notification {
  id              Int                @id @default(autoincrement())
  userId          String             @map("user_id") // Changed to String to match other services
  type            NotificationType
  title           String
  message         String
  data            Json?
  status          NotificationStatus @default(PENDING)
  deliveryChannel String?            @map("delivery_channel") // EMAIL, SMS, PUSH
  retryCount      Int                @default(0) @map("retry_count")
  maxRetries      Int                @default(3) @map("max_retries")
  scheduledAt     DateTime?          @map("scheduled_at") // For scheduled notifications
  sentAt          DateTime?          @map("sent_at")
  readAt          DateTime?          @map("read_at")
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  @@index([userId, status])
  @@index([userId, readAt])          // getUnreadCount, markAllAsRead, findAll(unreadOnly)
  @@index([userId, createdAt(sort: Desc)]) // findAll with pagination (orderBy createdAt desc)
  @@index([type, status])
  @@index([status, scheduledAt])     // findScheduledNotifications
  @@index([status, retryCount])      // findFailedNotificationsForRetry
  @@map("notifications")
}

model NotificationTemplate {
  id        Int              @id @default(autoincrement())
  type      NotificationType
  title     String
  content   String
  variables Json?            // 템플릿 변수 정의
  isActive  Boolean          @default(true) @map("is_active")
  createdAt DateTime         @default(now()) @map("created_at")
  updatedAt DateTime         @updatedAt @map("updated_at")

  @@index([type, isActive])  // findByType (called for every notification)
  @@map("notification_templates")
}

model NotificationSettings {
  id        Int     @id @default(autoincrement())
  userId    String  @unique @map("user_id") // Changed to String to match other services
  email     Boolean @default(true)
  sms       Boolean @default(false)
  push      Boolean @default(true)
  marketing Boolean @default(false)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("notification_settings")
}

enum NotificationType {
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  FRIEND_REQUEST
  FRIEND_ACCEPTED
  CHAT_MESSAGE
  SYSTEM_ALERT
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  READ
}

model DeadLetterNotification {
  id              Int              @id @default(autoincrement())
  originalId      Int              @map("original_id")
  userId          String           @map("user_id")
  type            NotificationType
  title           String
  message         String
  data            Json?
  deliveryChannel String?          @map("delivery_channel")
  failureReason   String           @map("failure_reason")
  retryCount      Int              @map("retry_count")
  movedAt         DateTime         @default(now()) @map("moved_at")

  @@index([userId])
  @@index([movedAt])
  @@map("dead_letter_notifications")
}
